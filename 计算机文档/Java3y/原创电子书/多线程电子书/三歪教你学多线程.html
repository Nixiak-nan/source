<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>三歪教你学多线程</title><link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color: #ffffff; --text-color: #333333; --select-text-bg-color: #B5D6FC; --select-text-font-color: auto; --monospace: "Lucida Console",Consolas,"Courier",monospace; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857143; overflow-x: hidden; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; tab-size: 4; background-position: inherit inherit; background-repeat: inherit inherit; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; word-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 40px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
@media screen and (max-width: 500px) { 
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; }
button, input, select, textarea { color: inherit; font-family: inherit; font-size: inherit; font-style: inherit; font-variant-caps: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 2; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.701961); color: rgb(85, 85, 85); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px !important; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right-width: 0px; background-color: inherit; }
.CodeMirror-linenumber { }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; position: relative !important; background-position: inherit inherit; background-repeat: inherit inherit; }
.md-diagram-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; background-position: 0px 0px; background-repeat: initial initial; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print { 
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  html.blink-to-pdf { font-size: 13px; }
  .typora-export #write { padding-left: 32px; padding-right: 32px; padding-bottom: 0px; break-after: avoid; }
  .typora-export #write::after { height: 0px; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background-color: rgb(204, 204, 204); display: block; overflow-x: hidden; background-position: initial initial; background-repeat: initial initial; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) { 
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background-color: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-top-left-radius: 3px; border-top-right-radius: 3px; border-bottom-right-radius: 3px; border-bottom-left-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; background-position: initial initial; background-repeat: initial initial; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; }
a.md-print-anchor { white-space: pre !important; border: none !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; text-shadow: initial !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: hidden; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; zoom: 90%; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; }
.MathJax_SVG * { transition: none; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom-width: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
svg[id^="mermaidChart"] { line-height: 1em; }
mark { background-color: rgb(255, 255, 0); color: rgb(0, 0, 0); background-position: initial initial; background-repeat: initial initial; }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
mark .md-meta { color: rgb(0, 0, 0); opacity: 0.3 !important; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-scroll { overflow-y: hidden; overflow-x: auto; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right-width: 1px; border-right-style: solid; border-right-color: rgb(221, 221, 221); background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; white-space: nowrap; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background-image: inherit; background-size: inherit; background-attachment: inherit; background-origin: inherit; background-clip: inherit; background-color: inherit; background-position: inherit inherit; background-repeat: inherit inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; border: none !important; background-position: 0px 0px !important; background-repeat: initial initial !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-top-left-radius: 0px; border-top-right-radius: 0px; border-bottom-right-radius: 0px; border-bottom-left-radius: 0px; border-width: 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; word-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; background-position: 0px 0px; background-repeat: initial initial; }
.CodeMirror-wrap pre { word-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right-width: 30px; border-right-style: solid; border-right-color: transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right-style: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right-style: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background-color: rgba(255, 255, 0, 0.4); background-position: initial initial; background-repeat: initial initial; }
@media print { 
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans","Helvetica Neue",Helvetica,Arial,sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}
#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    padding-bottom: .3em;
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
   padding-bottom: .3em;
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}
h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border-top: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table tr th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table tr td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table tr th:first-child,
table tr td:first-child {
    margin-top: 0;
}
table tr th:last-child,
table tr td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

.html-for-mac .context-menu {
    --item-hover-bg-color: #E6F0FE;
}

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}


</style>
</head>
<body class='typora-export' >
<div  id='write'  class = 'is-mac'><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1730"><a class="md-toc-inner" href="#前言">前言</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1701"><a class="md-toc-inner" href="#一什么是多线程">一、什么是多线程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n3"><a class="md-toc-inner" href="#一初识多线程">一、初识多线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n4"><a class="md-toc-inner" href="#11介绍进程">1.1介绍进程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n14"><a class="md-toc-inner" href="#12回到线程">1.2回到线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n36"><a class="md-toc-inner" href="#13进程与线程">1.3进程与线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n71"><a class="md-toc-inner" href="#14并行与并发">1.4并行与并发</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n89"><a class="md-toc-inner" href="#15java实现多线程">1.5Java实现多线程</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n101"><a class="md-toc-inner" href="#151继承thread重写run方法">1.5.1继承Thread，重写run方法</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n107"><a class="md-toc-inner" href="#152实现runnable接口重写run方法">1.5.2实现Runnable接口，重写run方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n113"><a class="md-toc-inner" href="#16java实现多线程需要注意的细节">1.6Java实现多线程需要注意的细节</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n140"><a class="md-toc-inner" href="#二thread类解析">二、Thread类解析</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n142"><a class="md-toc-inner" href="#一thread线程类api">一、Thread线程类API</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n147"><a class="md-toc-inner" href="#11设置线程名">1.1设置线程名</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n174"><a class="md-toc-inner" href="#12守护线程">1.2守护线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n199"><a class="md-toc-inner" href="#13优先级线程">1.3优先级线程</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n208"><a class="md-toc-inner" href="#14线程生命周期">1.4线程生命周期</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n214"><a class="md-toc-inner" href="#141sleep方法">1.4.1sleep方法</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n219"><a class="md-toc-inner" href="#142yield方法">1.4.2yield方法</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n227"><a class="md-toc-inner" href="#143join方法">1.4.3join方法</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n236"><a class="md-toc-inner" href="#143interrupt方法">1.4.3interrupt方法</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n285"><a class="md-toc-inner" href="#三使用多线程需要注意的问题">三、使用多线程需要注意的问题</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n417"><a class="md-toc-inner" href="#一使用多线程遇到的问题">一、使用多线程遇到的问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n418"><a class="md-toc-inner" href="#11线程安全问题">1.1线程安全问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n453"><a class="md-toc-inner" href="#13性能问题">1.3性能问题</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n467"><a class="md-toc-inner" href="#二对象的发布与逸出">二、对象的发布与逸出</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n491"><a class="md-toc-inner" href="#21安全发布对象">2.1安全发布对象</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n515"><a class="md-toc-inner" href="#三解决多线程遇到的问题">三、解决多线程遇到的问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n518"><a class="md-toc-inner" href="#31简述解决线程安全性的办法">3.1简述解决线程安全性的办法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n539"><a class="md-toc-inner" href="#32原子性和可见性">3.2原子性和可见性</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n541"><a class="md-toc-inner" href="#321原子性">3.2.1原子性</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n555"><a class="md-toc-inner" href="#322可见性">3.2.2可见性</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n589"><a class="md-toc-inner" href="#33线程封闭">3.3线程封闭</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n596"><a class="md-toc-inner" href="#34不变性">3.4不变性</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n625"><a class="md-toc-inner" href="#35线程安全性委托">3.5线程安全性委托</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n630"><a class="md-toc-inner" href="#四多线程需要注意的事--总结">四、多线程需要注意的事 -总结</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n642"><a class="md-toc-inner" href="#四synchronized锁和lock锁">四、synchronized锁和lock锁</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n659"><a class="md-toc-inner" href="#一synchronized锁">一、synchronized锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n660"><a class="md-toc-inner" href="#11synchronized锁是什么">1.1synchronized锁是什么？</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n674"><a class="md-toc-inner" href="#12synchronized用处是什么">1.2synchronized用处是什么？</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n681"><a class="md-toc-inner" href="#13synchronized的原理">1.3synchronized的原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n696"><a class="md-toc-inner" href="#14synchronized如何使用">1.4synchronized如何使用</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n705"><a class="md-toc-inner" href="#141修饰普通方法">1.4.1修饰普通方法：</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n709"><a class="md-toc-inner" href="#142修饰代码块">1.4.2修饰代码块：</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n723"><a class="md-toc-inner" href="#143修饰静态方法">1.4.3修饰静态方法</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n726"><a class="md-toc-inner" href="#144类锁与对象锁">1.4.4类锁与对象锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n738"><a class="md-toc-inner" href="#15重入锁">1.5重入锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n751"><a class="md-toc-inner" href="#16释放锁的时机">1.6释放锁的时机</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n760"><a class="md-toc-inner" href="#二lock显式锁">二、Lock显式锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n761"><a class="md-toc-inner" href="#21lock显式锁简单介绍">2.1Lock显式锁简单介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n779"><a class="md-toc-inner" href="#22synchronized锁和lock锁使用哪个">2.2synchronized锁和Lock锁使用哪个</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n787"><a class="md-toc-inner" href="#23公平锁">2.3公平锁</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n800"><a class="md-toc-inner" href="#三java锁简单总结">三、Java锁简单总结</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n816"><a class="md-toc-inner" href="#五aqs">五、AQS</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n821"><a class="md-toc-inner" href="#一aqs是什么">一、AQS是什么？</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n859"><a class="md-toc-inner" href="#二简单看看aqs">二、简单看看AQS</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n861"><a class="md-toc-inner" href="#21同步状态">2.1同步状态</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n866"><a class="md-toc-inner" href="#22先进先出队列">2.2先进先出队列</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n871"><a class="md-toc-inner" href="#23acquire方法">2.3acquire方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n881"><a class="md-toc-inner" href="#24release方法">2.4release方法</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n900"><a class="md-toc-inner" href="#六reentrantlock和reentrantreadwritelock">六、ReentrantLock和ReentrantReadWriteLock</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n908"><a class="md-toc-inner" href="#一reentrantlock锁">一、ReentrantLock锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n920"><a class="md-toc-inner" href="#11内部类">1.1内部类</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n928"><a class="md-toc-inner" href="#12构造方法">1.2构造方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n930"><a class="md-toc-inner" href="#13非公平lock方法">1.3非公平lock方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n937"><a class="md-toc-inner" href="#14公平lock方法">1.4公平lock方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n942"><a class="md-toc-inner" href="#15unlock方法">1.5unlock方法</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n948"><a class="md-toc-inner" href="#二reentrantreadwritelock">二、ReentrantReadWriteLock</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n976"><a class="md-toc-inner" href="#21reentrantreadwritelock内部类">2.1ReentrantReadWriteLock内部类</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n984"><a class="md-toc-inner" href="#22读锁和写锁的状态表示">2.2读锁和写锁的状态表示</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n987"><a class="md-toc-inner" href="#23写锁的获取">2.3写锁的获取</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n992"><a class="md-toc-inner" href="#24读锁获取">2.4读锁获取</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n997"><a class="md-toc-inner" href="#三最后">三、最后</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1019"><a class="md-toc-inner" href="#七线程池">七、线程池</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1021"><a class="md-toc-inner" href="#一线程池简介">一、线程池简介</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1035"><a class="md-toc-inner" href="#二jdk提供的线程池api">二、JDK提供的线程池API</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1055"><a class="md-toc-inner" href="#21forkjoinpool线程池">2.1ForkJoinPool线程池</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1065"><a class="md-toc-inner" href="#22补充callable和future">2.2补充：Callable和Future</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1089"><a class="md-toc-inner" href="#三threadpoolexecutor详解">三、ThreadPoolExecutor详解</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1093"><a class="md-toc-inner" href="#31内部状态">3.1内部状态</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1112"><a class="md-toc-inner" href="#32已默认实现的池">3.2已默认实现的池</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1122"><a class="md-toc-inner" href="#321newfixedthreadpool">3.2.1newFixedThreadPool</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1125"><a class="md-toc-inner" href="#322newcachedthreadpool">3.2.2newCachedThreadPool</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1128"><a class="md-toc-inner" href="#323singlethreadexecutor">3.2.3SingleThreadExecutor</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1131"><a class="md-toc-inner" href="#33构造方法">3.3构造方法</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1186"><a class="md-toc-inner" href="#四execute执行方法">四、execute执行方法</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1189"><a class="md-toc-inner" href="#五线程池关闭">五、线程池关闭</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1208"><a class="md-toc-inner" href="#八死锁">八、死锁</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1210"><a class="md-toc-inner" href="#一死锁讲解">一、死锁讲解</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1223"><a class="md-toc-inner" href="#11锁顺序死锁">1.1锁顺序死锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1239"><a class="md-toc-inner" href="#12动态锁顺序死锁">1.2动态锁顺序死锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1254"><a class="md-toc-inner" href="#13协作对象之间发生死锁">1.3协作对象之间发生死锁</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1263"><a class="md-toc-inner" href="#二避免死锁的方法">二、避免死锁的方法</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1275"><a class="md-toc-inner" href="#21固定锁顺序避免死锁">2.1固定锁顺序避免死锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1283"><a class="md-toc-inner" href="#22开放调用避免死锁">2.2开放调用避免死锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1294"><a class="md-toc-inner" href="#23使用定时锁">2.3使用定时锁</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1297"><a class="md-toc-inner" href="#24死锁检测">2.4死锁检测</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1309"><a class="md-toc-inner" href="#三死锁总结">三、死锁总结</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1338"><a class="md-toc-inner" href="#九线程常用的工具类">九、线程常用的工具类</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1349"><a class="md-toc-inner" href="#一countdownlatch">一、CountDownLatch</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1350"><a class="md-toc-inner" href="#11countdownlatch简介">1.1CountDownLatch简介</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1364"><a class="md-toc-inner" href="#12countdownlatch例子">1.2CountDownLatch例子</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1374"><a class="md-toc-inner" href="#二cyclicbarrier">二、CyclicBarrier</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1375"><a class="md-toc-inner" href="#21cyclicbarrier简介">2.1CyclicBarrier简介</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1385"><a class="md-toc-inner" href="#22cyclicbarrier例子">2.2CyclicBarrier例子</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1395"><a class="md-toc-inner" href="#三semaphore">三、Semaphore</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1396"><a class="md-toc-inner" href="#31semaphore简介">3.1Semaphore简介</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1412"><a class="md-toc-inner" href="#32semaphore例子">3.2Semaphore例子</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1419"><a class="md-toc-inner" href="#四总结">四、总结</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1448"><a class="md-toc-inner" href="#十atomic">十、Atomic</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1450"><a class="md-toc-inner" href="#一基础铺垫">一、基础铺垫</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1480"><a class="md-toc-inner" href="#12cas再来看看">1.2CAS再来看看</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1508"><a class="md-toc-inner" href="#121cas失败重试自旋">1.2.1CAS失败重试(自旋)</a></span><span role="listitem" class="md-toc-item md-toc-h4" data-ref="n1513"><a class="md-toc-inner" href="#122cas失败什么都不做">1.2.2CAS失败什么都不做</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1518"><a class="md-toc-inner" href="#二原子变量类简单介绍">二、原子变量类简单介绍</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1568"><a class="md-toc-inner" href="#21原子变量类使用">2.1原子变量类使用</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1573"><a class="md-toc-inner" href="#22aba问题">2.2ABA问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1589"><a class="md-toc-inner" href="#23解决aba问题">2.3解决ABA问题</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1598"><a class="md-toc-inner" href="#24longadder性能比atomiclong要好">2.4LongAdder性能比AtomicLong要好</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n1621"><a class="md-toc-inner" href="#十一threadlocal">十一、ThreadLocal</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1623"><a class="md-toc-inner" href="#一什么是threadlocal">一、什么是ThreadLocal</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1630"><a class="md-toc-inner" href="#二为什么要学习threadlocal">二、为什么要学习ThreadLocal？</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1632"><a class="md-toc-inner" href="#21管理connection">2.1管理Connection</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1638"><a class="md-toc-inner" href="#22避免一些参数传递">2.2避免一些参数传递</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1656"><a class="md-toc-inner" href="#三threadlocal实现的原理">三、ThreadLocal实现的原理</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1676"><a class="md-toc-inner" href="#31threadlocal原理总结">3.1ThreadLocal原理总结</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1689"><a class="md-toc-inner" href="#四避免内存泄露">四、避免内存泄露</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n1694"><a class="md-toc-inner" href="#五总结">五、总结</a></span></p></div><p>&nbsp;</p><h1><a name="前言" class="md-header-anchor"></a><span>前言</span></h1><p><span>这个文档的内容</span><strong><span>纯手打</span></strong><span>，如果想要看更多的干货文章，关注我的公众号：</span><strong><span>Java3y</span></strong><span>。有更多的原创技术文章和干货！</span></p><p>&nbsp;</p><p><span>目前疯狂处于</span><strong><span>疯狂</span></strong><span>更新PDF中，只要是Java后端的知识，都会有！</span><strong><span>欢迎来我公众号催更！</span></strong><span>微信搜索：</span><strong><span>Java3y</span></strong></p><p>&nbsp;</p><p><span>如果文档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！公众号有我的</span><strong><span>联系方式</span></strong></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><ul><li><span>🔥</span><strong><span>Java精美脑图</span></strong></li><li><span>🔥</span><strong><span>Java学习路线</span></strong></li><li><span>🔥</span><strong><span>开发常用工具</span></strong></li><li><span>🔥</span><strong><span>精美原创电子书</span></strong></li></ul><p><span>在公众号下回复「</span><strong><span>888</span></strong><span>」即可获取！！</span></p><p>&nbsp;</p><p><strong><span>学习不能盲目，跟着我，会让你事半功倍</span></strong></p><p>&nbsp;</p><p><strong><span>文档允许随意传播，但不能修改任何内容。</span></strong></p><p>&nbsp;</p><p><span>电子书的整理也是挺不容易，如果你觉得有帮助，想要打赏作者，那么可以通过这个收款码打赏我，</span><strong><span>金额不重要，心意最重要</span></strong><span>。主要是我可以通过这个打赏情况来预计大家对这本电子书的评价，嘻嘻</span></p><p>&nbsp;</p><p><img src='https://tva1.sinaimg.cn/large/00831rSTly1gcuu0j4wwqj30u014qako.jpg' width=200px height=200px /><img src='https://tva1.sinaimg.cn/large/00831rSTly1gcuuckh3s4j30rc0yo7jr.jpg' width=200px height=200px /></p><p>&nbsp;</p><p>&nbsp;</p><h1><a name="一什么是多线程" class="md-header-anchor"></a><span>一、什么是多线程</span></h1><h2><a name="一初识多线程" class="md-header-anchor"></a><span>一、初识多线程</span></h2><h3><a name="11介绍进程" class="md-header-anchor"></a><span>1.1介绍进程</span></h3><p><span>讲到线程，又不得不提进程了~</span></p><p><span>进程我们估计是很了解的了，在windows下打开任务管理器，可以发现我们在操作系统上运行的程序都是进程：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d19700426594e?w=1226&amp;h=742&amp;f=png&amp;s=33712" referrerpolicy="no-referrer"></p><p><strong><span>进程的定义：</span></strong></p><blockquote><p><span>进程是</span><strong><span>程序的一次执行</span></strong><span>，进程是一个程序及其数据在处理机上顺序执行时所发生的</span><strong><span>活动</span></strong><span>，进程是具有独立功能的程序在一个数据集合上运行的过程，它是系统进行资源</span><strong><span>分配和调度的一个独立单位</span></strong></p></blockquote><ul><li><strong><span>进程是系统进行资源分配和调度的独立单位。每一个进程都有它自己的内存空间和系统资源</span></strong></li></ul><h3><a name="12回到线程" class="md-header-anchor"></a><span>1.2回到线程</span></h3><p><span>那系统有了进程这么一个概念了，进程已经是可以进行资源分配和调度了，</span><strong><span>为什么还要线程呢</span></strong><span>？</span></p><p><span>为使程序能并发执行，系统必须进行以下的一系列操作：</span></p><ul><li><span>(1)</span><strong><span>创建进程</span></strong><span>，系统在创建一个进程时，必须为它分配其所必需的、除处理机以外的所有资源，如内存空间、I/O设备，以及建立相应的PCB；</span></li><li><span>(2)</span><strong><span>撤消进程</span></strong><span>，系统在撤消进程时，又必须先对其所占有的资源执行回收操作，然后再撤消PCB；</span></li><li><span>(3)</span><strong><span>进程切换</span></strong><span>，对进程进行上下文切换时，需要保留当前进程的CPU环境，设置新选中进程的CPU环境，因而须花费不少的处理机时间。</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d197003f05abb?w=1057&amp;h=550&amp;f=png&amp;s=124683" referrerpolicy="no-referrer"></p><p><span>可以看到进程实现多处理机环境下的进程调度，分派，切换时，</span><strong><span>都需要花费较大的时间和空间开销</span></strong></p><p><span>引入线程主要是</span><strong><span>为了提高系统的执行效率，减少处理机的空转时间和调度切换的时间，以及便于系统管理。</span></strong><span>使OS具有更好的并发性</span></p><ul><li><span>简单来说：</span><strong><span>进程实现多处理</span></strong><span>非常耗费CPU的资源，而我们</span><strong><span>引入线程是作为调度和分派的基本单位</span></strong><span>（取代进程的部分基本功能</span><strong><span>【调度】</span></strong><span>）。</span></li></ul><p><span>那么线程在哪呢？？举个例子：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d19700699f6bb?w=891&amp;h=553&amp;f=png&amp;s=43546" referrerpolicy="no-referrer"></p><p><span>也就是说：</span><strong><span>在同一个进程内又可以执行多个任务，而这每一个任务我就可以看出是一个线程</span></strong><span>。</span></p><ul><li><span>所以说：</span><strong><span>一个进程会有1个或多个线程的</span></strong><span>！</span></li></ul><h3><a name="13进程与线程" class="md-header-anchor"></a><span>1.3进程与线程</span></h3><p><span>于是我们可以总结出：</span></p><ul><li><span>进程作为资源</span><strong><span>分配</span></strong><span>的基本单位</span></li><li><span>线程作为资源</span><strong><span>调度</span></strong><span>的基本单位，</span><strong><span>是程序的执行单元，执行路径</span></strong><span>(单线程：一条执行路径，多线程：多条执行路径)。是程序使用CPU的最基本单位。</span></li></ul><p><span>线程有</span><strong><span>3个基本状态</span></strong><span>：</span></p><ul><li><span>执行、就绪、阻塞</span></li></ul><p><span>线程有</span><strong><span>5种基本操作</span></strong><span>：</span></p><ul><li><span>派生、阻塞、激活、 调度、 结束</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d1981d884c051?w=1080&amp;h=1440&amp;f=jpeg&amp;s=151856" referrerpolicy="no-referrer"></p><p><strong><span>线程的属性：</span></strong></p><ul><li><span>1)轻型实体；</span></li><li><span>2)独立调度和分派的基本单位；</span></li><li><span>3)可并发执行；</span></li><li><span>4)共享进程资源。</span></li></ul><p><span>线程有</span><strong><span>两个基本类型</span></strong><span>：</span></p><ul><li><span>1) </span><strong><span>用户级线程</span></strong><span>：管理过程全部由用户程序完成，</span><strong><span>操作系统内核心只对进程进行管理。</span></strong></li><li><span>2) </span><strong><span>系统级线程</span></strong><span>(核心级线程)：</span><strong><span>由操作系统内核进行管理</span></strong><span>。操作系统内核给应用程序提供相应的系统调用和应用程序接口API，以使用户程序可以创建、执行以及撤消线程。</span></li></ul><p>&nbsp;</p><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d1970068ffcce?w=1213&amp;h=556&amp;f=png&amp;s=15885" referrerpolicy="no-referrer"></p><p><span>值得注意的是：多线程的存在，不是提高程序的执行速度。其实</span><strong><span>是为了提高应用程序的使用率</span></strong><span>，程序的执行其实都是在</span><strong><span>抢CPU的资源</span></strong><span>，CPU的执行权。多个进程是在抢这个资源，</span><strong><span>而其中的某一个进程如果执行路径比较多</span></strong><span>，就会有</span><strong><span>更高的几率</span></strong><span>抢到CPU的执行权</span></p><h3><a name="14并行与并发" class="md-header-anchor"></a><span>1.4并行与并发</span></h3><p><strong><span>并行：</span></strong></p><ul><li><span>并行性是指</span><strong><span>同一时刻内</span></strong><span>发生两个或多个事件。</span></li><li><span>并行是在</span><strong><span>不同</span></strong><span>实体上的多个事件</span></li></ul><p><strong><span>并发：</span></strong></p><ul><li><span>并发性是指</span><strong><span>同一时间间隔内</span></strong><span>发生两个或多个事件。</span></li><li><span>并发是在</span><strong><span>同一实体</span></strong><span>上的多个事件</span></li></ul><p><span>由此可见：并行是针对进程的，</span><strong><span>并发是针对线程的</span></strong><span>。</span></p><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnmsw5j75j30730733yj.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><h3><a name="15java实现多线程" class="md-header-anchor"></a><span>1.5Java实现多线程</span></h3><p><span>上面说了一大堆基础，理解完的话。我们回到Java中，看看Java是如何实现多线程的~</span></p><p><span>Java实现多线程是使用Thread这个类的，我们来看看</span><strong><span>Thread类的顶部注释</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d197b72808c43?w=1918&amp;h=2973&amp;f=png&amp;s=196014" referrerpolicy="no-referrer"></p><p><span>通过上面的顶部注释我们就可以发现，创建多线程有</span><strong><span>两种</span></strong><span>方法：</span></p><ul><li><span>继承Thread，重写run方法</span></li><li><span>实现Runnable接口，重写run方法</span></li><li><span>实现Callable接口，重写run方法</span></li></ul><h4><a name="151继承thread重写run方法" class="md-header-anchor"></a><span>1.5.1继承Thread，重写run方法</span></h4><p><strong><span>创建一个类，继承Thread，重写run方法</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyThread</span> <span class="cm-keyword">extends</span> <span class="cm-variable">Thread</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">x</span> <span class="cm-operator">&lt;</span> <span class="cm-number">200</span>; <span class="cm-variable">x</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">x</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p><span>我们调用一下测试看看：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyThreadDemo</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 创建两个线程对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">MyThread</span> <span class="cm-variable">my1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyThread</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">MyThread</span> <span class="cm-variable">my2</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyThread</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">my1</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">my2</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d197b72b7c2ee?w=703&amp;h=869&amp;f=png&amp;s=11267" referrerpolicy="no-referrer"></p><h4><a name="152实现runnable接口重写run方法" class="md-header-anchor"></a><span>1.5.2实现Runnable接口，重写run方法</span></h4><p><strong><span>实现Runnable接口，重写run方法</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyRunnable</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Runnable</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">x</span> <span class="cm-operator">&lt;</span> <span class="cm-number">100</span>; <span class="cm-variable">x</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">x</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><p><span>我们调用一下测试看看：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyRunnableDemo</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 创建MyRunnable类的对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">MyRunnable</span> <span class="cm-variable">my</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyRunnable</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Thread</span> <span class="cm-variable">t1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">my</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Thread</span> <span class="cm-variable">t2</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">my</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">t1</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">t2</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>结果还是跟上面是</span><strong><span>一样</span></strong><span>的，这里我就不贴图了~~~</span></p><h3><a name="16java实现多线程需要注意的细节" class="md-header-anchor"></a><span>1.6Java实现多线程需要注意的细节</span></h3><p><span>不要将</span><code>run()</code><span>和</span><code>start()</code><span>搞混了~</span></p><p><strong><span>run()和start()方法区别：</span></strong></p><ul><li><code>run()</code><span>:仅仅是</span><strong><span>封装被线程执行的代码</span></strong><span>，直接调用是普通方法</span></li><li><code>start()</code><span>:首先</span><strong><span>启动了线程</span></strong><span>，然后再</span><strong><span>由jvm去调用该线程的run()方法。</span></strong></li></ul><hr /><p><strong><span>jvm虚拟机的启动是单线程的还是多线程的?</span></strong></p><ul><li><strong><span>是多线程的</span></strong><span>。不仅仅是启动main线程，还至少会启动垃圾回收线程的，不然谁帮你回收不用的内存~</span></li></ul><p>&nbsp;</p><p><span>那么，既然有两种方式实现多线程，我们</span><strong><span>使用哪一种</span></strong><span>？？？</span></p><p><strong><span>一般我们使用实现Runnable接口</span></strong></p><ul><li><strong><span>可以避免java中的单继承的限制</span></strong></li><li><span>应该将并发</span><strong><span>运行任务和运行机制解耦</span></strong><span>，因此我们选择实现Runnable接口这种方式！</span></li></ul><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnmtk5zjog306o06odg1.gif" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><h1><a name="二thread类解析" class="md-header-anchor"></a><span>二、Thread类解析</span></h1><p>&nbsp;</p><h2><a name="一thread线程类api" class="md-header-anchor"></a><span>一、Thread线程类API</span></h2><blockquote><p><span>声明本文使用的是JDK1.8</span></p></blockquote><p><span>实现多线程从本质上都是由Thread类来进行操作的~我们来看看Thread类一些</span><strong><span>重要的知识点</span></strong><span>。Thread这个类很大，不可能整个把它看下来，只能</span><strong><span>看一些常见的、重要的方法</span></strong><span>。</span></p><p>&nbsp;</p><h3><a name="11设置线程名" class="md-header-anchor"></a><span>1.1设置线程名</span></h3><p><span>我们在使用多线程的时候，想要查看线程名是很简单的，调用</span><code>Thread.currentThread().getName()</code><span>即可。</span></p><p><span>如果没有做什么的设置，我们会发现线程的名字是这样子的：</span><strong><span>主线程叫做main，其他线程是Thread-x</span></strong></p><p><span>下面我就带着大家来看看它是怎么命名的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1492b6ab0d?w=1212&amp;h=144&amp;f=png&amp;s=5483" referrerpolicy="no-referrer"></p><p><code>nextThreadNum()</code><span>的方法实现是这样的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1491036dd3?w=745&amp;h=102&amp;f=png&amp;s=3091" referrerpolicy="no-referrer"></p><p><span>基于这么一个变量--&gt;</span><strong><span>线程初始化的数量</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1492ea1418?w=1004&amp;h=194&amp;f=png&amp;s=8525" referrerpolicy="no-referrer"></p><p><span>点进去看到init方法就可以确定了：</span>
<img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e149635ef31?w=1053&amp;h=228&amp;f=png&amp;s=12423" referrerpolicy="no-referrer"></p><p><span>看到这里，如果我们想要为线程起个名字，那也是很简单的。</span><strong><span>Thread给我们提供了构造方法</span></strong><span>！</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e14924a10f1?w=778&amp;h=160&amp;f=png&amp;s=5062" referrerpolicy="no-referrer"></p><p><span>下面我们来测试一下：</span></p><ul><li><span>实现了Runnable的方式来实现多线程：</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyThread</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Runnable</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 打印出当前线程的名字</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">getName</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><span>测试：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyThreadDemo</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">MyThread</span> <span class="cm-variable">myThread</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyThread</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//带参构造方法给线程起名字</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">thread1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">myThread</span>, <span class="cm-string">"关注公众号Java3y"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">thread2</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">myThread</span>, <span class="cm-string">"qq群：742919422"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">thread1</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">thread2</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 打印当前线程的名字</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">getName</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><p><span>结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e148b75f9f5?w=722&amp;h=208&amp;f=png&amp;s=6031" referrerpolicy="no-referrer"></p><p><span>当然了，我们还可以通过</span><code>setName(String name)</code><span>的方法来改掉线程的名字的。我们来看看方法实现；</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e154023b41f?w=986&amp;h=265&amp;f=png&amp;s=9298" referrerpolicy="no-referrer"></p><p><span>检查是否有权限修改：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e15bff0d77b?w=1000&amp;h=274&amp;f=png&amp;s=9241" referrerpolicy="no-referrer"></p><p><span>至于threadStatus这个状态属性，</span><strong><span>貌似没发现他会在哪里修改</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1538cfbe15?w=906&amp;h=333&amp;f=png&amp;s=7857" referrerpolicy="no-referrer"></p><h3><a name="12守护线程" class="md-header-anchor"></a><span>1.2守护线程</span></h3><p><span>守护线程是</span><strong><span>为其他线程服务的</span></strong></p><ul><li><strong><span>垃圾回收线程就是守护线程</span></strong><span>~</span></li></ul><p><span>守护线程有一个</span><strong><span>特点</span></strong><span>：</span></p><ul><li><span>当别的用户线程执行完了，虚拟机就会退出，守护线程也就会被停止掉了。</span></li><li><span>也就是说：守护线程作为一个</span><strong><span>服务线程，没有服务对象就没有必要继续运行</span></strong><span>了</span></li></ul><p><strong><span>使用线程的时候要注意的地方</span></strong></p><ol><li><strong><span>在线程启动前</span></strong><span>设置为守护线程，方法是</span><code>setDaemon(boolean on)</code></li><li><span>使用守护线程</span><strong><span>不要访问共享资源</span></strong><span>(数据库、文件等)，因为它可能会在任何时候就挂掉了。</span></li><li><span>守护线程中产生的新线程也是守护线程</span></li></ol><p><span>测试一波：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyThreadDemo</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">MyThread</span> <span class="cm-variable">myThread</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyThread</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//带参构造方法给线程起名字</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">thread1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">myThread</span>, <span class="cm-string">"关注公众号Java3y"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">thread2</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">myThread</span>, <span class="cm-string">"qq群：742919422"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 设置为守护线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">thread2</span>.<span class="cm-variable">setDaemon</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">thread1</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">thread2</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">getName</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><p><span>上面的代码运行多次可以出现(电脑性能足够好的同学可能测试不出来)：</span><strong><span>线程1和主线程执行完了，我们的守护线程就不执行了</span></strong><span>~</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e154d433bfd?w=637&amp;h=194&amp;f=png&amp;s=5227" referrerpolicy="no-referrer"></p><p><span>原理：这也就为什么我们要在</span><strong><span>启动之前</span></strong><span>设置守护线程了。</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e158a2d73c5?w=855&amp;h=218&amp;f=png&amp;s=8802" referrerpolicy="no-referrer"></p><h3><a name="13优先级线程" class="md-header-anchor"></a><span>1.3优先级线程</span></h3><p><span>线程优先级高仅仅表示线程</span><strong><span>获取的CPU时间片的几率高</span></strong><span>，但这不是一个</span><strong><span>确定的因素</span></strong><span>！</span></p><p><span>线程的优先级是</span><strong><span>高度依赖于操作系统的</span></strong><span>，Windows和Linux就有所区别(Linux下优先级可能就被忽略了)~</span></p><p><span>可以看到的是，Java提供的优先级默认是5，最低是1，最高是10：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e156df6aa64?w=794&amp;h=403&amp;f=png&amp;s=10422" referrerpolicy="no-referrer"></p><p><span>实现：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e15d61c11d4?w=1142&amp;h=471&amp;f=png&amp;s=19979" referrerpolicy="no-referrer"></p><p><code>setPriority0</code><span>是一个本地(navite)的方法：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">private</span> <span class="cm-keyword">native</span> <span class="cm-variable-3">void</span> <span class="cm-def">setPriority0</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">newPriority</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><h3><a name="14线程生命周期" class="md-header-anchor"></a><span>1.4线程生命周期</span></h3><p><span>在上一篇介绍的时候其实也提过了线程的线程有3个基本状态：执行、就绪、阻塞</span></p><p><span>在Java中我们就有了这个图，Thread上很多的方法都是</span><strong><span>用来切换线程的状态</span></strong><span>的，这一部分是重点！</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/17/162d1981d884c051?w=1080&amp;h=1440&amp;f=jpeg&amp;s=151856" referrerpolicy="no-referrer"></p><p><span>其实上面这个图是不够完整的，</span><strong><span>省略</span></strong><span>掉了一些东西。后面在讲解的线程状态的时候我会重新画一个~</span></p><p><span>下面就来讲解与线程生命周期相关的方法~</span></p><h4><a name="141sleep方法" class="md-header-anchor"></a><span>1.4.1sleep方法</span></h4><p><span>调用sleep方法会进入计时等待状态，等时间到了，</span><strong><span>进入的是就绪状态而并非是运行状态</span></strong><span>！</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e15ed7f6efa?w=1136&amp;h=535&amp;f=png&amp;s=23493" referrerpolicy="no-referrer"></p><p><span>于是乎，我们的图就可以补充成这样：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e15f2b616c9?w=1183&amp;h=742&amp;f=png&amp;s=31288" referrerpolicy="no-referrer"></p><h4><a name="142yield方法" class="md-header-anchor"></a><span>1.4.2yield方法</span></h4><p><span>调用yield方法会先</span><strong><span>让别的线程执行</span></strong><span>，但是</span><strong><span>不确保真正让出</span></strong></p><ul><li><span>意思是：</span><strong><span>我有空，可以的话，让你们先执行</span></strong></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1629a9f27c?w=1381&amp;h=484&amp;f=png&amp;s=26395" referrerpolicy="no-referrer"></p><p><span>于是乎，我们的图就可以补充成这样：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e16264b9c5d?w=1155&amp;h=748&amp;f=png&amp;s=38803" referrerpolicy="no-referrer"></p><h4><a name="143join方法" class="md-header-anchor"></a><span>1.4.3join方法</span></h4><p><span>调用join方法，会等待</span><strong><span>该线程</span></strong><span>执行</span><strong><span>完毕后才执行别的线程</span></strong><span>~</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e166e37c59a?w=1067&amp;h=512&amp;f=png&amp;s=17537" referrerpolicy="no-referrer"></p><p><span>我们进去看看</span><strong><span>具体的实现</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e16a08b92c4?w=1918&amp;h=1677&amp;f=png&amp;s=139853" referrerpolicy="no-referrer"></p><p><span>wait方法是在Object上定义的，它是native本地方法，所以就看不了了：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e16ab75dedf?w=1208&amp;h=65&amp;f=png&amp;s=3295" referrerpolicy="no-referrer"></p><p><strong><span>wait</span></strong><span>方法实际上它也是</span><strong><span>计时等待(如果带时间参数)</span></strong><span>的一种！，于是我们可以补充我们的图：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e16a948847f?w=1140&amp;h=745&amp;f=png&amp;s=46361" referrerpolicy="no-referrer"></p><h4><a name="143interrupt方法" class="md-header-anchor"></a><span>1.4.3interrupt方法</span></h4><p><span>线程中断在之前的版本有stop方法，但是被设置过时了。现在已经</span><strong><span>没有强制线程终止</span></strong><span>的方法了！</span></p><p><span>由于stop方法可以让</span><strong><span>一个线程A终止掉另一个线程B</span></strong></p><ul><li><span>被终止的线程B会立即释放锁，这可能会让</span><strong><span>对象处于不一致的状态</span></strong><span>。</span></li><li><strong><span>线程A也不知道线程B什么时候能够被终止掉</span></strong><span>，万一线程B还处理运行计算阶段，线程A调用stop方法将线程B终止，那就很无辜了~</span></li></ul><p><span>总而言之，Stop方法太暴力了，不安全，所以被设置过时了。</span></p><p><span>我们一般使用的是interrupt来</span><strong><span>请求终止线程</span></strong><span>~</span></p><ul><li><span>要注意的是：interrupt</span><strong><span>不会真正停止</span></strong><span>一个线程，它仅仅是给这个线程发了一个信号告诉它，它应该要结束了(明白这一点非常重要！)</span></li><li><span>也就是说：Java设计者实际上是</span><strong><span>想线程自己来终止</span></strong><span>，通过上面的</span><strong><span>信号</span></strong><span>，就可以判断处理什么业务了。</span></li><li><span>具体到底中断还是继续运行，应该</span><strong><span>由被通知的线程自己处理</span></strong></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Thread</span> <span class="cm-variable">t1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>( <span class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>(){</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 若未发生中断，就正常执行任务</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span>(<span class="cm-operator">!</span><span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>.<span class="cm-variable">isInterrupted</span>()){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 正常任务代码……</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 中断的处理代码……</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">doSomething</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">} ).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p><span>再次说明：调用interrupt()</span><strong><span>并不是要真正终止掉当前线程</span></strong><span>，仅仅是设置了一个中断标志。这个中断标志可以给我们用来判断</span><strong><span>什么时候该干什么活</span></strong><span>！什么时候中断</span><strong><span>由我们自己来决定</span></strong><span>，这样就可以</span><strong><span>安全地终止线程</span></strong><span>了！</span></p><p><span>我们来看看源码是怎么讲的吧：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e16e2e908f9?w=1918&amp;h=2001&amp;f=png&amp;s=202141" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><span>再来看看刚才说抛出的异常是什么东东吧：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e16e562fe4f?w=1305&amp;h=713&amp;f=png&amp;s=37025" referrerpolicy="no-referrer"></p><p><span>所以说：</span><strong><span>interrupt方法压根是不会对线程的状态造成影响的，它仅仅设置一个标志位罢了</span></strong></p><p><span>interrupt线程中断还有另外</span><strong><span>两个方法(检查该线程是否被中断)</span></strong><span>：</span></p><ul><li><span>静态方法interrupted()--&gt;</span><strong><span>会清除中断标志位</span></strong></li><li><span>实例方法isInterrupted()--&gt;</span><strong><span>不会清除中断标志位</span></strong></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1738e3b65b?w=1214&amp;h=454&amp;f=png&amp;s=20208" referrerpolicy="no-referrer"></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e17784bf5da?w=1232&amp;h=596&amp;f=png&amp;s=28434" referrerpolicy="no-referrer"></p><p><span>上面还提到了，如果阻塞线程调用了interrupt()方法，那么会</span><strong><span>抛出异常，设置标志位为false，同时该线程会退出阻塞</span></strong><span>的。我们来测试一波：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Main</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param args</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Main</span> <span class="cm-variable">main</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Main</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 创建线程并启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">main</span>.<span class="cm-variable">runnable</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"This is main "</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 在 main线程睡个3秒钟</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">3000</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"In main"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 设置中断</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span>.<span class="cm-variable">interrupt</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">Runnable</span> <span class="cm-variable">runnable</span> <span class="cm-operator">=</span> () <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">1000</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 睡个半秒钟我们再执行</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">500</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">i</span><span class="cm-operator">++</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 判断该阻塞线程是否还在</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">isAlive</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 判断该线程的中断标志位状态</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">isInterrupted</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"In Runnable"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  };</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1100px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1100px;"></div></div></div></pre><p><span>结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e175c87cfbb?w=706&amp;h=435&amp;f=png&amp;s=9660" referrerpolicy="no-referrer"></p><p><span>接下来我们分析它的</span><strong><span>执行流程</span></strong><span>是怎么样的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/18/162d8e1786e316a1?w=1473&amp;h=752&amp;f=png&amp;s=47688" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnz2dvm1xg3073073q65.gif" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h1><a name="三使用多线程需要注意的问题" class="md-header-anchor"></a><span>三、使用多线程需要注意的问题</span></h1><p>&nbsp;</p><p><span>首先来预览一下《Java并发编程实战》前4章的目录究竟在讲什么吧：</span></p><p><strong><span>第1章　简介</span></strong></p><ul><li><span>1.1　并发简史</span></li><li><span>1.2　线程的优势</span></li><li><span>1.2.1　发挥多处理器的强大能力</span></li><li><span>1.2.2　建模的简单性</span></li><li><span>1.2.3　异步事件的简化处理</span></li><li><span>1.2.4　响应更灵敏的用户界面</span></li><li><span>1.3　线程带来的风险</span></li><li><span>1.3.1　安全性问题</span></li><li><span>1.3.2　活跃性问题</span></li><li><span>1.3.3　性能问题</span></li><li><span>1.4　线程无处不在</span></li></ul><p><span>ps：</span><strong><span>这一部分我就不讲了</span></strong><span>，主要是引出我们接下来的知识点，有兴趣的同学可翻看原书~</span></p><p>&nbsp;</p><p><strong><span>第2章　线程安全性</span></strong></p><ul><li><span>2.1　什么是线程安全性</span></li><li><span>2.2　原子性</span></li><li><span>2.2.1　竞态条件</span></li><li><span>2.2.2　示例：延迟初始化中的竞态条件</span></li><li><span>2.2.3　复合操作</span></li><li><span>2.3　加锁机制</span></li><li><span>2.3.1　内置锁</span></li><li><span>2.3.2　重入</span></li><li><span>2.4　用锁来保护状态</span></li><li><span>2.5　活跃性与性能</span></li></ul><p>&nbsp;</p><p><strong><span>第3章　对象的共享</span></strong></p><ul><li><span>3.1　可见性</span></li><li><span>3.1.1　失效数据</span></li><li><span>3.1.2　非原子的64位操作</span></li><li><span>3.1.3　加锁与可见性</span></li><li><span>3.1.4　Volatile变量 </span></li><li><span>3.2　发布与逸出</span></li><li><span>3.3　线程封闭</span></li><li><span>3.3.1　Ad-hoc线程封闭</span></li><li><span>3.3.2　栈封闭</span></li><li><span>3.3.3　ThreadLocal类</span></li><li><span>3.4　不变性</span></li><li><span>3.4.1　Final域</span></li><li><span>3.4.2　示例：使用Volatile类型来发布不可变对象</span></li><li><span>3.5　安全发布</span></li><li><span>3.5.1　不正确的发布：正确的对象被破坏</span></li><li><span>3.5.2 　不可变对象与初始化安全性</span></li><li><span>3.5.3　安全发布的常用模式</span></li><li><span>3.5.4　事实不可变对象</span></li><li><span>3.5.5　可变对象</span></li><li><span>3.5.6　安全地共享对象</span></li></ul><p>&nbsp;</p><p><strong><span>第4章　对象的组合</span></strong></p><ul><li><span>4.1　设计线程安全的类</span></li><li><span>4.1.1　收集同步需求</span></li><li><span>4.1.2　依赖状态的操作</span></li><li><span>4.1.3　状态的所有权</span></li><li><span>4.2　实例封闭</span></li><li><span>4.2.1　Java监视器模式</span></li><li><span>4.2.2　示例：车辆追踪</span></li><li><span>4.3　线程安全性的委托</span></li><li><span>4.3.1　示例：基于委托的车辆追踪器</span></li><li><span>4.3.2　独立的状态变量</span></li><li><span>4.3.3　当委托失效时</span></li><li><span>4.3.4　发布底层的状态变量</span></li><li><span>4.3.5　示例：发布状态的车辆追踪器</span></li><li><span>4.4　在现有的线程安全类中添加功能</span></li><li><span>4.4.1　客户端加锁机制</span></li><li><span>4.4.2　组合</span></li><li><span>4.5　将同步策略文档化</span></li></ul><p><span>那么接下来我们就开始吧~</span></p><h2><a name="一使用多线程遇到的问题" class="md-header-anchor"></a><span>一、使用多线程遇到的问题</span></h2><h3><a name="11线程安全问题" class="md-header-anchor"></a><span>1.1线程安全问题</span></h3><p><span>在前面的文章中已经讲解了线程【</span><a href='https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247484186&amp;idx=1&amp;sn=2a7b937e6d3b1623aceac199d3e402f9&amp;chksm=ebd7421bdca0cb0d6206db8c7f063c884c3f0b285975c8e896fde424660b4ccb88da1549f32c#rd'><span>多线程三分钟就可以入个门了！</span></a><span>】，多线程主要是为了提高我们</span><strong><span>应用程序的使用率</span></strong><span>。但同时，这会给我们</span><strong><span>带来很多安全问题</span></strong><span>！</span></p><p><span>如果我们在</span><strong><span>单线程</span></strong><span>中以“顺序”(串行--&gt;独占)的方式执行代码</span><strong><span>是没有任何问题</span></strong><span>的。但是到了多线程的环境下(并行)，如果没有设计和控制得好，就会给我们带来很多</span><strong><span>意想不到的状况，也就是线程安全性问题</span></strong></p><p><span>因为在多线程的环境下，线程是</span><strong><span>交替执行</span></strong><span>的，一般他们会使用多个线程</span><strong><span>执行相同的代码</span></strong><span>。如果在此相同的代码里边有着</span><strong><span>共享的变量</span></strong><span>，或者一些</span><strong><span>组合操作</span></strong><span>，我们想要的</span><strong><span>正确</span></strong><span>结果就很容易出现了问题</span></p><p><span>简单举个例子：</span></p><ul><li><strong><span>下面的程序在单线程中跑起来，是没有问题的</span></strong><span>。</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UnsafeCountingServlet</span> <span class="cm-keyword">extends</span> <span class="cm-variable">GenericServlet</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Servlet</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">long</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">long</span> <span class="cm-variable">getCount</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">service</span>(<span class="cm-variable">ServletRequest</span> <span class="cm-variable">servletRequest</span>, <span class="cm-variable">ServletResponse</span> <span class="cm-variable">servletResponse</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ServletException</span>, <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">++</span><span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// To something else...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>但是在多线程环境下跑起来，它的</span><strong><span>count值计算</span></strong><span>就不对了！</span></p><p><span>首先，它</span><strong><span>共享</span></strong><span>了count这个变量，其次来说</span><code>++count;</code><span>这是一个</span><strong><span>组合的操作</span></strong><span>(注意，</span><strong><span>它并非是原子性</span></strong><span>）</span></p><ul><li><p><code>++count</code><span>实际上的操作是这样子的：</span></p><ul><li><span>读取count值</span></li><li><span>将值+1</span></li><li><span>将计算结果写入count</span></li></ul></li></ul><p><span>于是多线程执行的时候</span><strong><span>很可能</span></strong><span>就会有这样的情况：</span></p><ul><li><span>当线程A读取到count的值是8的时候，</span><strong><span>同时</span></strong><span>线程B也进去这个方法上了，也是读取到count的值为8</span></li><li><span>它俩都对值进行加1</span></li><li><span>将计算结果写入到count上。但是，</span><strong><span>写入到count上的结果是9</span></strong></li><li><span>也就是说：两个线程进来了，但是</span><strong><span>正确的结果是应该返回10</span></strong><span>，而它返回了9，这是不正常的！</span></li></ul><p><span>如果说：当多个线程访问某个类的时候，这个类</span><strong><span>始终</span></strong><span>能表现出</span><strong><span>正确的行为</span></strong><span>，那么这个类就是线程安全的！</span></p><p>&nbsp;</p><p><span>有个原则：</span><strong><span>能使用JDK提供的线程安全机制，就使用JDK的</span></strong><span>。</span></p><p><span>当然了，此部分其实是我们</span><strong><span>学习多线程最重要的环节</span></strong><span>，这里我就不详细说了。这里只是一个总览，这些知识点在后面的学习中都会遇到~~~</span></p><h3><a name="13性能问题" class="md-header-anchor"></a><span>1.3性能问题</span></h3><p><span>使用多线程我们的目的就是为了提高应用程序的使用率，但是如果多线程的代码</span><strong><span>没有好好设计</span></strong><span>的话，那未必会提高效率。</span><strong><span>反而降低了效率，甚至会造成死锁</span></strong><span>！</span></p><p><span>就比如说我们的Servlet，一个Servlet对象可以处理多个请求的，</span><strong><span>Servlet显然是一个天然支持多线程的</span></strong><span>。</span></p><p><span>又以下面的例子来说吧：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UnsafeCountingServlet</span> <span class="cm-keyword">extends</span> <span class="cm-variable">GenericServlet</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Servlet</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">long</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">long</span> <span class="cm-variable">getCount</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">service</span>(<span class="cm-variable">ServletRequest</span> <span class="cm-variable">servletRequest</span>, <span class="cm-variable">ServletResponse</span> <span class="cm-variable">servletResponse</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ServletException</span>, <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">++</span><span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// To something else...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>从上面我们已经说了，上面</span><strong><span>这个类是线程不安全的</span></strong><span>。最简单的方式：如果我们在service方法上加上JDK为我们提供的内置锁synchronized，那么我们就可以实现线程安全了。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">UnsafeCountingServlet</span> <span class="cm-keyword">extends</span> <span class="cm-variable">GenericServlet</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Servlet</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">long</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">long</span> <span class="cm-variable">getCount</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable">service</span>(<span class="cm-variable">ServletRequest</span> <span class="cm-variable">servletRequest</span>, <span class="cm-variable">ServletResponse</span> <span class="cm-variable">servletResponse</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ServletException</span>, <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">++</span><span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// To something else...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>虽然实现了线程安全了，但是这会带来</span><strong><span>很严重的性能问题</span></strong><span>：</span></p><ul><li><span>每个请求都得</span><strong><span>等待</span></strong><span>上一个请求的service方法</span><strong><span>处理了以后</span></strong><span>才可以完成对应的操作</span></li></ul><p><span>这就导致了：我们完成一个小小的功能，使用了多线程的目的是想要提高效率，但现在</span><strong><span>没有把握得当，却带来严重的性能问题</span></strong><span>！</span></p><p><span>在使用多线程的时候：更严重的时候还有</span><strong><span>死锁</span></strong><span>(程序就卡住不动了)。</span></p><p><span>这些都是我们接下来要学习的地方：</span><strong><span>学习使用哪种同步机制来实现线程安全，并且性能是提高了而不是降低了</span></strong><span>~</span></p><h2><a name="二对象的发布与逸出" class="md-header-anchor"></a><span>二、对象的发布与逸出</span></h2><p><span>书上是这样定义发布和逸出的：</span></p><blockquote><p><span>发布(publish) 使对象能够在当前作用域之外的代码中使用</span></p></blockquote><blockquote><p><span>逸出(escape) 当某个不应该发布的对象被发布了</span></p></blockquote><p><span>常见</span><strong><span>逸出</span></strong><span>的有下面几种方式：</span></p><ul><li><span>静态域逸出</span></li><li><span>public修饰的get方法</span></li><li><span>方法参数传递</span></li><li><span>隐式的this</span></li></ul><p><strong><span>静态域逸出：</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1bc076486dc1?w=812&amp;h=335&amp;f=png&amp;s=32972" referrerpolicy="no-referrer"></p><p><strong><span>public修饰get方法：</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1bc07650b883?w=1124&amp;h=368&amp;f=png&amp;s=20030" referrerpolicy="no-referrer"></p><p><strong><span>方法参数传递我就不再演示了</span></strong><span>，因为把对象传递过去给另外的方法，已经是逸出了~</span></p><p><span>下面来看看该书给出</span><strong><span>this逸出的例子</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1ba7316d50b7?w=951&amp;h=682&amp;f=png&amp;s=50995" referrerpolicy="no-referrer"></p><p><strong><span>逸出就是本不应该发布对象的地方，把对象发布了</span></strong><span>。导致我们的</span><strong><span>数据泄露</span></strong><span>出去了，这就造成了一个</span><strong><span>安全隐患</span></strong><span>！理解起来是不是简单了一丢丢？</span></p><h3><a name="21安全发布对象" class="md-header-anchor"></a><span>2.1安全发布对象</span></h3><p><span>上面谈到了好几种逸出的情况，我们接下来来谈谈</span><strong><span>如何安全发布对象</span></strong><span>。</span></p><p><span>安全发布对象有几种常见的方式：</span></p><ul><li><p><strong><span>在静态域中直接初始化</span></strong><span> ： </span><code>public static Person = new Person()</code><span>;</span></p><ul><li><span>静态初始化由JVM在类的初始化阶段就执行了，</span><strong><span>JVM内部存在着同步机制</span></strong><span>，致使这种方式我们可以安全发布对象</span></li></ul></li><li><p><span>对应的引用保存到</span><strong><span>volatile或者AtomicReferance引用中</span></strong></p><ul><li><span>保证了该对象的引用的可见性和原子性</span></li></ul></li><li><p><strong><span>由final修饰</span></strong></p><ul><li><span>该对象是不可变的，那么线程就一定是安全的，所以是安全发布~</span></li></ul></li><li><p><strong><span>由锁来保护</span></strong></p><ul><li><span>发布和使用的时候都需要加锁，这样才保证能够该对象不会逸出</span></li></ul></li></ul><h2><a name="三解决多线程遇到的问题" class="md-header-anchor"></a><span>三、解决多线程遇到的问题</span></h2><p><span>从上面我们就可以看到，使用多线程会把我们的系统搞得挺复杂的。是需要我们去处理很多事情，为了防止多线程给我们带来的安全和性能的问题~</span></p><p><span>下面就来</span><strong><span>简单总结</span></strong><span>一下我们需要哪些知识点来解决多线程遇到的问题。</span></p><h3><a name="31简述解决线程安全性的办法" class="md-header-anchor"></a><span>3.1简述解决线程安全性的办法</span></h3><p><span>使用多线程就一定要</span><strong><span>保证我们的线程是安全的</span></strong><span>，这是最重要的地方！</span></p><p><span>在Java中，我们一般会有下面这么几种办法来实现线程安全问题：</span></p><ul><li><p><span>无状态(</span><strong><span>没有共享变量</span></strong><span>)</span></p></li><li><p><span>使用final使该引用变量不可变(如果该对象引用也引用了其他的对象，那么无论是发布或者使用时都需要加锁)</span></p></li><li><p><span>加锁(内置锁，显示Lock锁)</span></p></li><li><p><span>使用JDK为我们提供的类来实现线程安全(此部分的类就很多了)</span></p><ul><li><span>原子性（就比如上面的</span><code>count++</code><span>操作，可以使用AtomicLong来实现原子性，那么在增加的时候就不会出差错了！)</span></li><li><span>容器(ConcurrentHashMap等等...)</span></li><li><span>......</span></li></ul></li><li><p><span>...等等</span></p></li></ul><h3><a name="32原子性和可见性" class="md-header-anchor"></a><span>3.2原子性和可见性</span></h3><p><span>何为原子性？何为可见性？当初我在</span><a href='https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247484161&amp;idx=1&amp;sn=6f52fb1f714f3ffd2f96a5ee4ebab146&amp;chksm=ebd74200dca0cb16288db11f566cb53cafc580e08fe1c570e0200058e78676f527c014ffef41#rd'><span>ConcurrentHashMap基于JDK1.8源码剖析</span></a><span>中已经简单说了一下了。不了解的同学可以进去看看。</span></p><h4><a name="321原子性" class="md-header-anchor"></a><span>3.2.1原子性</span></h4><p><span>在多线程中很多时候都是因为某个操作不是原子性的，使数据混乱出错。如果操作的数据是原子性的，那么就可以很大程度上避免了线程安全问题了！</span></p><ul><li><code>count++</code><span>，先读取，后自增，再赋值。</span><strong><span>如果该操作是原子性的，那么就可以说线程安全了(因为没有中间的三部环节，一步到位【原子性】</span></strong><span>~</span></li></ul><p><strong><span>原子性</span></strong><span>就是执行</span><strong><span>某一个操作是不可分割的</span></strong><span>，</span></p><ul><li><span>比如上面所说的</span><code>count++</code><span>操作，它就不是一个原子性的操作，它是分成了三个步骤的来实现这个操作的~</span></li><li><span>JDK中有atomic包提供给我们实现原子性操作</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1bad6356e81b?w=447&amp;h=468&amp;f=png&amp;s=7069" referrerpolicy="no-referrer"></p><p><span>也有人将其做成了表格来分类，我们来看看：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1bad635317ec?w=997&amp;h=196&amp;f=png&amp;s=10072" referrerpolicy="no-referrer" alt="图片来源：https://blog.csdn.net/eson_15/article/details/51553338"></p><h4><a name="322可见性" class="md-header-anchor"></a><span>3.2.2可见性</span></h4><p><span>对于</span><strong><span>可见性</span></strong><span>，Java提供了一个关键字：volatile给我们使用~</span></p><ul><li><span>我们可以简单认为：volatile是一种</span><strong><span>轻量级的同步机制</span></strong></li></ul><p><span>volatile经典总结：</span><strong><span>volatile仅仅用来保证该变量对所有线程的可见性，但不保证原子性</span></strong></p><p><span>我们将其拆开来解释一下：</span></p><ul><li><p><span>保证</span><strong><span>该变量对所有线程的可见性</span></strong></p><ul><li><span>在多线程的环境下：当这个变量修改时，</span><strong><span>所有的线程都会知道该变量被修改了</span></strong><span>，也就是所谓的“可见性”</span></li></ul></li><li><p><span>不保证原子性</span></p><ul><li><span>修改变量(赋值)</span><strong><span>实质上</span></strong><span>是在JVM中</span><strong><span>分了好几步</span></strong><span>，而</span><strong><span>在这几步内(从装载变量到修改)，它是不安全的</span></strong><span>。</span></li></ul></li></ul><p><span>使用了volatile修饰的变量</span><strong><span>保证了三点</span></strong><span>：</span></p><ul><li><strong><span>一旦你完成写入，任何访问这个字段的线程将会得到最新的值</span></strong></li><li><span>在你写入前，</span><strong><span>会保证所有之前发生的事已经发生</span></strong><span>，并且任何更新过的数据值也是可见的，因为内存屏障会把之前的写入值都刷新到缓存。</span></li><li><strong><span>volatile可以防止重排序</span></strong><span>(重排序指的就是：程序执行的时候，CPU、编译器可能会</span><strong><span>对执行顺序做一些调整</span></strong><span>，导致执行的顺序并不是从上往下的。从而出现了一些意想不到的效果)。而如果声明了volatile，那么CPU、编译器就会知道</span><strong><span>这个变量是共享的</span></strong><span>，不会被缓存在寄存器或者其他不可见的地方。</span></li></ul><p><span>一般来说，</span><strong><span>volatile大多用于标志位上(判断操作)</span></strong><span>,满足下面的条件才应该使用volatile修饰变量：</span></p><ul><li><strong><span>修改变量时不依赖变量的当前值</span></strong><span>(因为volatile是不保证原子性的)</span></li><li><strong><span>该变量不会纳入到不变性条件中</span></strong><span>(该变量是可变的)</span></li><li><strong><span>在访问变量的时候不需要加锁</span></strong><span>(加锁就没必要使用volatile这种轻量级同步机制了)</span></li></ul><h3><a name="33线程封闭" class="md-header-anchor"></a><span>3.3线程封闭</span></h3><p><span>在多线程的环境下，只要我们</span><strong><span>不使用成员变量(不共享数据)</span></strong><span>,那么就不会出现线程安全的问题了。</span></p><p><span>就用我们熟悉的Servlet来举例子，写了那么多的Servlet，你见过我们说要加锁吗？？我们所有的数据都是在方法(栈封闭)上操作的，</span><strong><span>每个线程都拥有自己的变量，互不干扰</span></strong><span>！</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1bc07660b36c?w=1310&amp;h=662&amp;f=png&amp;s=23294" referrerpolicy="no-referrer"></p><p><span>在方法上操作，</span><strong><span>只要我们保证不要在栈(方法)上发布对象</span></strong><span>(每个变量的作用域仅仅停留在当前的方法上)，那么我们的线程就是安全的</span></p><p><span>在线程封闭上还有另一种方法，就是我之前写过的：</span><a href='https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247484118&amp;idx=1&amp;sn=da3e4c4cfd0642687c5d7bcef543fe5b&amp;chksm=ebd743d7dca0cac19a82c7b29b5b22c4b902e9e53bd785d066b625b4272af2a6598a0cc0f38e#rd'><span>ThreadLocal就是这么简单</span></a></p><p><span>使用这个类的API就可以</span><strong><span>保证每个线程自己独占一个变量</span></strong><span>。(详情去读上面的文章即可)~</span></p><h3><a name="34不变性" class="md-header-anchor"></a><span>3.4不变性</span></h3><blockquote><p><span>不可变对象一定线程安全的。</span></p></blockquote><p><span>上面我们共享的变量都是可变的，正由于是可变的才会出现线程安全问题。如果</span><strong><span>该状态是不可变的</span></strong><span>，那么</span><strong><span>随便多个线程访问都是没有问题的</span></strong><span>！</span></p><p><span>Java提供了final修饰符给我们使用，final的身影我们可能就见得比较多了，但值得说明的是：</span></p><ul><li><strong><span>final仅仅是不能修改该变量的引用，但是引用里边的数据是可以改的!</span></strong></li></ul><p><span>就好像下面这个HashMap，用final修饰了。但是它仅仅保证了该</span><strong><span>对象引用</span></strong><code>hashMap变量</code><span>所指向是不可变的，但是hashMap内部的数据是可变的，也就是说：可以add，remove等等操作到集合中~~~</span></p><ul><li><span>因此，仅仅只能够说明</span><strong><span>hashMap是一个不可变的对象引用</span></strong></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">HashMap</span><span class="cm-operator">&lt;</span><span class="cm-variable">Person</span><span class="cm-operator">&gt;</span> <span class="cm-variable">hashMap</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashMap</span><span class="cm-operator">&lt;&gt;</span>();</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><strong><span>不可变的对象引用</span></strong><span>在使用的时候还是</span><strong><span>需要加锁</span></strong><span>的</span></p><ul><li><span>或者把Person也设计成是一个线程安全的类~</span></li><li><span>因为内部的状态是可变的，</span><strong><span>不加锁或者Person不是线程安全类，操作都是有危险的</span></strong><span>！</span></li></ul><p><span>要想将对象设计成不可变对象，那么要满足下面三个条件：</span></p><ul><li><strong><span>对象创建后状态就不能修改</span></strong></li><li><strong><span>对象所有的域都是final修饰的</span></strong></li><li><strong><span>对象是正确创建的</span></strong><span>(没有this引用逸出)</span></li></ul><p><span>String在我们学习的过程中我们就知道它是一个</span><strong><span>不可变对象</span></strong><span>，但是它没有遵循第二点(对象所有的域都是final修饰的)，因为JVM在内部做了优化的。但是我们如果是要自己设计不可变对象，是需要满足三个条件的。</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1ba7ca4ace44?w=1162&amp;h=591&amp;f=png&amp;s=27076" referrerpolicy="no-referrer"></p><h3><a name="35线程安全性委托" class="md-header-anchor"></a><span>3.5线程安全性委托</span></h3><p><span>很多时候我们要实现线程安全</span><strong><span>未必就需要自己加锁，自己来设计</span></strong><span>。</span></p><p><span>我们可以使用JDK给我们提供的对象来完成线程安全的设计：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/23/162f1ba80170c71a?w=574&amp;h=676&amp;f=png&amp;s=11787" referrerpolicy="no-referrer"></p><p><span>非常多的&quot;工具类&quot;供我们使用，这些在往后的学习中都会有所介绍的~~这里就不介绍了</span></p><h2><a name="四多线程需要注意的事--总结" class="md-header-anchor"></a><span>四、多线程需要注意的事 -总结</span></h2><p>&nbsp;</p><p><span>正确使用多线程能够提高我们应用程序的效率，同时给我们会带来非常多的问题，这些都是我们在使用多线程之前需要注意的地方。</span></p><p><span>无论是不变性、可见性、原子性、线程封闭、委托这些都是实现线程安全的一种</span><strong><span>手段</span></strong><span>。要合理地使用这些手段，我们的程序才可以更加健壮！</span></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnmqukanpg30640643zd.gif" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h1><a name="四synchronized锁和lock锁" class="md-header-anchor"></a><span>四、synchronized锁和lock锁</span></h1><p>&nbsp;</p><p><span>本文章主要讲的是Java多线程</span><strong><span>加锁机制</span></strong><span>，有两种：</span></p><ul><li><span>Synchronized</span></li><li><span>显式Lock</span></li></ul><p><span>不得不唠叨几句：</span></p><ul><li><span>在《Java核心技术卷 一》是先讲比较难的显式Lock，而再讲的是比较简单的Synchronized</span></li><li><span>而《Java并发编程实战》在前4章零散地讲解了Synchronized，将显式Lock放到了13章</span></li></ul><p><span>其实</span><strong><span>都比较坑</span></strong><span>，如果能先系统讲了Synchronized锁机制，接着讲显式Lock锁机制，那就很容易理解了。也不需要跨那么多章节。</span></p><p>&nbsp;</p><p><span>那么接下来我们就开始吧~</span></p><h2><a name="一synchronized锁" class="md-header-anchor"></a><span>一、synchronized锁</span></h2><h3><a name="11synchronized锁是什么" class="md-header-anchor"></a><span>1.1synchronized锁是什么？</span></h3><p><span>synchronized是Java的一个</span><strong><span>关键字</span></strong><span>，它能够将</span><strong><span>代码块(方法)锁起来</span></strong></p><ul><li><span>它使用起来是非常简单的，只要在代码块(方法)添加关键字synchronized，即可以</span><strong><span>实现同步</span></strong><span>的功能~</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-def">test</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 关注公众号Java3y</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// doSomething</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p><span>synchronized是一种</span><strong><span>互斥锁</span></strong></p><ul><li><strong><span>一次只能允许一个线程进入被锁住的代码块</span></strong></li></ul><p><span>synchronized是一种</span><strong><span>内置锁/监视器锁</span></strong></p><ul><li><span>Java中</span><strong><span>每个对象</span></strong><span>都有一个</span><strong><span>内置锁(监视器,也可以理解成锁标记)</span></strong><span>，而synchronized就是使用</span><strong><span>对象的内置锁(监视器)</span></strong><span>来将代码块(方法)锁定的！ (锁的是对象，但我们同步的是方法/代码块)</span></li></ul><h3><a name="12synchronized用处是什么" class="md-header-anchor"></a><span>1.2synchronized用处是什么？</span></h3><ul><li><span>synchronized保证了线程的</span><strong><span>原子性</span></strong><span>。(被保护的代码块是一次被执行的，没有任何线程会同时访问)</span></li><li><span>synchronized还保证了</span><strong><span>可见性</span></strong><span>。(当执行完synchronized之后，修改后的变量对其他的线程是可见的)</span></li></ul><p><span>Java中的synchronized，通过使用内置锁，来实现对变量的同步操作，进而实现了</span><strong><span>对变量操作的原子性和其他线程对变量的可见性</span></strong><span>，从而确保了并发情况下的线程安全。</span></p><h3><a name="13synchronized的原理" class="md-header-anchor"></a><span>1.3synchronized的原理</span></h3><p><span>我们首先来看一段synchronized修饰方法和代码块的代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Main</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//修饰方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">test1</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">test2</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 修饰代码块</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-keyword">this</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>来反编译看一下：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f76943723a1cf?w=1098&amp;h=721&amp;f=png&amp;s=18770" referrerpolicy="no-referrer"></p><p><strong><span>同步代码块</span></strong><span>：</span></p><ul><li><span>monitorenter和monitorexit指令实现的</span></li></ul><p><strong><span>同步方法</span></strong><span>（在这看不出来需要看JVM底层实现）</span></p><ul><li><span>方法修饰符上的ACC_SYNCHRONIZED实现。 </span></li></ul><p><span>synchronized底层是是</span><strong><span>通过monitor对象，对象有自己的对象头，存储了很多信息，其中一个信息标示是被哪个线程持有</span></strong><span>。</span></p><p>&nbsp;</p><h3><a name="14synchronized如何使用" class="md-header-anchor"></a><span>1.4synchronized如何使用</span></h3><p><span>synchronized一般我们用来修饰三种东西：</span></p><ul><li><span>修饰普通方法</span></li><li><span>修饰代码块</span></li><li><span>修饰静态方法</span></li></ul><h4><a name="141修饰普通方法" class="md-header-anchor"></a><span>1.4.1修饰普通方法：</span></h4><p>&nbsp;</p><p><span>用的锁是</span><strong><span>Java3y对象(内置锁)</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Java3y</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 修饰普通方法，此时用的锁是Java3y对象(内置锁)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">test</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 关注公众号Java3y</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// doSomething</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><h4><a name="142修饰代码块" class="md-header-anchor"></a><span>1.4.2修饰代码块：</span></h4><p><span>用的锁是</span><strong><span>Java3y对象(内置锁)</span></strong><span>---&gt;this</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Java3y</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> &nbsp;<span class="cm-variable-3">void</span> <span class="cm-variable">test</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 修饰代码块，此时用的锁是Java3y对象(内置锁)---&gt;this</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-keyword">this</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 关注公众号Java3y</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// doSomething</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p><span>当然了，我们使用synchronized修饰代码块时未必使用this，还可以</span><strong><span>使用其他的对象(随便一个对象都有一个内置锁)</span></strong></p><p><span>所以，我们可以这样干：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Java3y</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 使用object作为锁(任何对象都有对应的锁标记，object也不例外)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">object</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">Object</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">test</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 修饰代码块，此时用的锁是自己创建的锁Object</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">object</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 关注公众号Java3y</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// doSomething</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 396px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><p><span>上面那种方式(随便使用一个对象作为锁)在书上称之为--&gt;</span><strong><span>客户端锁</span></strong><span>，这是</span><strong><span>不建议使用的</span></strong><span>。</span></p><p><span>书上想要实现的功能是：给ArrayList添加一个</span><code>putIfAbsent()</code><span>，这需要是线程安全的。</span></p><p><strong><span>假定直接添加synchronized是不可行的</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f7694354307a9?w=1118&amp;h=245&amp;f=png&amp;s=13615" referrerpolicy="no-referrer"></p><p><strong><span>使用客户端锁，会将当前的实现与原本的list耦合了</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f76943774df73?w=1085&amp;h=385&amp;f=png&amp;s=12442" referrerpolicy="no-referrer"></p><p><span>书上给出的办法是使用</span><strong><span>组合</span></strong><span>的方式(也就是装饰器模式)</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f7694355f7fcc?w=1164&amp;h=664&amp;f=png&amp;s=21663" referrerpolicy="no-referrer"></p><h4><a name="143修饰静态方法" class="md-header-anchor"></a><span>1.4.3修饰静态方法</span></h4><p><span>获取到的是</span><strong><span>类锁(类的字节码文件对象)</span></strong><span>：Java3y.class</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Java3y</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 修饰静态方法代码块，静态方法属于类方法，它属于这个类，获取到的锁是属于类的锁(类的字节码文件对象)--&gt;Java3y.class</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> &nbsp;<span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">test</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 关注公众号Java3y</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// doSomething</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 220px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><h4><a name="144类锁与对象锁" class="md-header-anchor"></a><span>1.4.4类锁与对象锁</span></h4><p><span>synchronized修饰静态方法获取的是类锁(类的字节码文件对象)，synchronized修饰普通方法或代码块获取的是对象锁。</span></p><ul><li><span>它俩是不冲突的，也就是说：</span><strong><span>获取了类锁的线程和获取了对象锁的线程是不冲突的</span></strong><span>！</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">SynchoronizedDemo</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//synchronized修饰非静态方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">function</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">InterruptedException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span><span class="cm-number">3</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">1000</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"function running..."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//synchronized修饰静态方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">staticFunction</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throws</span> <span class="cm-variable">InterruptedException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">3</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">1000</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"Static function running..."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">SynchoronizedDemo</span> <span class="cm-variable">demo</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">SynchoronizedDemo</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 创建线程执行静态方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">t1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(() <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">staticFunction</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 创建线程执行实例方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">t2</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(() <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">demo</span>.<span class="cm-variable">function</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  });</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t1</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t2</span>.<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 946px;"></div><div class="CodeMirror-gutters" style="display: none; height: 946px;"></div></div></div></pre><p><span>结果证明：</span><strong><span>类锁和对象锁是不会冲突的</span></strong><span>！</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f7694382ef523?w=988&amp;h=271&amp;f=png&amp;s=5332" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyv09urzj30730733ye.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><h3><a name="15重入锁" class="md-header-anchor"></a><span>1.5重入锁</span></h3><p><span>我们来看下面的代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Widget</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 锁住了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">doSomething</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>...</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">LoggingWidget</span> <span class="cm-keyword">extends</span> <span class="cm-variable">Widget</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 锁住了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">doSomething</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">toString</span>() <span class="cm-operator">+</span> <span class="cm-string">": calling doSomething"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">super</span>.<span class="cm-variable">doSomething</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><ol><li><span>当线程A进入到LoggingWidget的</span><code>doSomething()</code><span>方法时，</span><strong><span>此时拿到了LoggingWidget实例对象的锁</span></strong><span>。</span></li><li><span>随后在方法上又调用了父类Widget的</span><code>doSomething()</code><span>方法，它</span><strong><span>又是被synchronized修饰</span></strong><span>。</span></li><li><span>那现在我们LoggingWidget实例对象的锁还没有释放，进入父类Widget的</span><code>doSomething()</code><span>方法</span><strong><span>还需要一把锁吗？</span></strong></li></ol><p><strong><span>不需要的！</span></strong></p><p><span>因为</span><strong><span>锁的持有者是“线程”，而不是“调用”</span></strong><span>。线程A已经是有了LoggingWidget实例对象的锁了，当再需要的时候可以继续</span><strong><span>“开锁”</span></strong><span>进去的！</span></p><p><span>这就是内置锁的</span><strong><span>可重入性</span></strong><span>。记住，</span><strong><span>持有锁的是线程</span></strong><span>。</span></p><h3><a name="16释放锁的时机" class="md-header-anchor"></a><span>1.6释放锁的时机</span></h3><ol><li><span>当方法(代码块)执行完毕后会</span><strong><span>自动释放锁</span></strong><span>，不需要做任何的操作。</span></li><li><strong><span>当一个线程执行的代码出现异常时，其所持有的锁会自动释放</span></strong><span>。</span></li></ol><ul><li><span>不会由于异常导致出现死锁现象~</span></li></ul><h2><a name="二lock显式锁" class="md-header-anchor"></a><span>二、Lock显式锁</span></h2><h3><a name="21lock显式锁简单介绍" class="md-header-anchor"></a><span>2.1Lock显式锁简单介绍</span></h3><p><span>Lock显式锁是JDK1.5之后才有的，之前我们都是使用Synchronized锁来使线程安全的~</span></p><p><span>Lock显式锁是一个接口，我们来看看：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f769eb628db65?w=470&amp;h=186&amp;f=png&amp;s=3889" referrerpolicy="no-referrer"></p><p><span>随便翻译一下他的顶部注释，看看是干嘛用的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/24/162f769475d5e980?w=1918&amp;h=3702&amp;f=png&amp;s=295264" referrerpolicy="no-referrer"></p><p><span>可以</span><strong><span>简单概括</span></strong><span>一下：</span></p><ul><li><span>Lock方式来获取锁</span><strong><span>支持中断、超时不获取、是非阻塞的</span></strong></li><li><strong><span>提高了语义化</span></strong><span>，哪里加锁，哪里解锁都得写出来</span></li><li><strong><span>Lock显式锁可以给我们带来很好的灵活性，但同时我们必须手动释放锁</span></strong></li><li><span>支持Condition条件对象</span></li><li><strong><span>允许多个读线程同时访问共享资源</span></strong></li></ul><h3><a name="22synchronized锁和lock锁使用哪个" class="md-header-anchor"></a><span>2.2synchronized锁和Lock锁使用哪个</span></h3><p><span>前面说了，Lock显式锁给我们的程序带来了很多的灵活性，很多特性都是Synchronized锁没有的。那Synchronized锁有没有存在的必要？？</span></p><p><span>必须是有的！！Lock锁在刚出来的时候很多性能方面都比Synchronized锁要好，但是从JDK1.6开始Synchronized锁就做了各种的优化(毕竟亲儿子，牛逼)</span></p><ul><li><span>优化操作：适应自旋锁，锁消除，锁粗化，轻量级锁，偏向锁。</span></li></ul><p><span>所以，到现在Lock锁和Synchronized锁的性能其实</span><strong><span>差别不是很大</span></strong><span>！而Synchronized锁用起来又特别简单。</span><strong><span>Lock锁还得顾忌到它的特性，要手动释放锁才行</span></strong><span>(如果忘了释放，这就是一个隐患)</span></p><p><span>所以说，我们</span><strong><span>绝大部分时候还是会使用Synchronized锁</span></strong><span>，用到了Lock锁提及的特性，带来的灵活性才会考虑使用Lock显式锁~</span></p><h3><a name="23公平锁" class="md-header-anchor"></a><span>2.3公平锁</span></h3><p><span>公平锁理解起来非常简单：</span></p><ul><li><span>线程将按照它们</span><strong><span>发出请求的顺序来获取锁</span></strong></li></ul><p><span>非公平锁就是：</span></p><ul><li><span>线程发出请求的时可以</span><strong><span>“插队”</span></strong><span>获取锁</span></li></ul><p><span>Lock和synchronize都是</span><strong><span>默认使用非公平锁的</span></strong><span>。如果不是必要的情况下，不要使用公平锁</span></p><ul><li><span>公平锁会来带一些性能的消耗的</span></li></ul><h2><a name="三java锁简单总结" class="md-header-anchor"></a><span>三、Java锁简单总结</span></h2><p><span>本文讲了synchronized内置锁和简单描述了一下Lock显式锁，总得来说：</span></p><ul><li><strong><span>synchronized好用，简单，性能不差</span></strong></li><li><span>没有使用到Lock显式锁的特性就不要使用Lock锁了。</span></li></ul><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnywo71jrg308c08caa4.gif" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h1><a name="五aqs" class="md-header-anchor"></a><span>五、AQS</span></h1><p>&nbsp;</p><p><span> 本来我是打算在这章节中写Lock的子类实现的，但看到了AQS的这么一个概念，</span><strong><span>可以说Lock的子类实现都是基于AQS的</span></strong><span>。</span></p><p><span>AQS我在面试题中也见过他的身影，但一直不知道是什么东西。所以本篇我就来讲讲AQS这个玩意吧，至少知道它的概念是什么，对吧~</span></p><p><span>那么接下来我们就开始吧~</span></p><h2><a name="一aqs是什么" class="md-header-anchor"></a><span>一、AQS是什么？</span></h2><p><span>首先我们来普及一下juc是什么：</span><strong><span>juc其实就是包的缩写(java.util.concurrnt)</span></strong></p><ul><li><span>不要被人家唬到了，以为juc是什么一个牛逼的东西。其实指的是包而已~</span></li></ul><p><span>我们可以发现lock包下有三个抽象的类：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fce90e1b8ee1a?w=576&amp;h=336&amp;f=png&amp;s=8452" referrerpolicy="no-referrer"></p><ul><li><span>AbstractOwnableSynchronizer</span></li><li><span>AbstractQueuedLongSynchronizer</span></li><li><span>AbstractQueuedSynchronizer</span></li></ul><p><span>通常地：</span><strong><span>AbstractQueuedSynchronizer简称为AQS</span></strong></p><p><span>我们Lock之类的两个常见的锁都是基于它来实现的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fce8ff1da9ad3?w=1547&amp;h=584&amp;f=png&amp;s=45218" referrerpolicy="no-referrer"></p><p><span>那么我们来看看AbstractQueuedSynchronizer到底是什么，看一个类是干什么的</span><strong><span>最快途径就是看它的顶部注释</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fcd34dd621e32?w=1864&amp;h=4179&amp;f=png&amp;s=799799" referrerpolicy="no-referrer"></p><p><span>通读了一遍，可以总结出以下</span><strong><span>比较关键</span></strong><span>的信息：</span></p><ul><li><p><span>AQS其实就是一个可以给我们实现锁的</span><strong><span>框架</span></strong></p></li><li><p><span>内部实现的关键是：</span><strong><span>先进先出的队列、state状态</span></strong></p></li><li><p><span>定义了内部类ConditionObject</span></p></li><li><p><span>拥有两种线程模式</span></p><ul><li><span>独占模式</span></li><li><span>共享模式</span></li></ul></li><li><p><span>在LOCK包中的相关锁(常用的有ReentrantLock、 ReadWriteLock)都是</span><strong><span>基于AQS来构建</span></strong></p></li><li><p><span>一般我们</span><strong><span>叫AQS为同步器</span></strong></p></li></ul><h2><a name="二简单看看aqs" class="md-header-anchor"></a><span>二、简单看看AQS</span></h2><p><span>上面也提到了AQS里边最重要的是状态和队列，我们接下来就看看其源码是怎么样的...</span></p><h3><a name="21同步状态" class="md-header-anchor"></a><span>2.1同步状态</span></h3><p><span>使用volatile修饰实现线程可见性：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fce8ff1d54454?w=1076&amp;h=556&amp;f=png&amp;s=18707" referrerpolicy="no-referrer"></p><p><span>修改state状态值时使用CAS算法来实现：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fcd34d0c54ba4?w=1152&amp;h=441&amp;f=png&amp;s=22899" referrerpolicy="no-referrer"></p><h3><a name="22先进先出队列" class="md-header-anchor"></a><span>2.2先进先出队列</span></h3><p><span>这个队列被称为：CLH队列(三个名字组成)，是一个</span><strong><span>双向队列</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fcd34d15d5270?w=1088&amp;h=686&amp;f=png&amp;s=32819" referrerpolicy="no-referrer"></p><p><span>看看它队列源码的组成：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-keyword">class</span> <span class="cm-def">Node</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 共享</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">Node</span> <span class="cm-variable">SHARED</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Node</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 独占</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">Node</span> <span class="cm-variable">EXCLUSIVE</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 线程被取消了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">CANCELLED</span> <span class="cm-operator">=</span> &nbsp;<span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 后继线程需要唤醒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">SIGNAL</span> &nbsp; &nbsp;<span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">1</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 等待condition唤醒</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">CONDITION</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">2</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 共享式同步状态获取将会无条件地传播下去(没看懂)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">PROPAGATE</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-number">3</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 初始为0，状态是上面的几种</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">volatile</span> <span class="cm-variable-3">int</span> <span class="cm-variable">waitStatus</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 前置节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">volatile</span> <span class="cm-variable">Node</span> <span class="cm-variable">prev</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 后继节点</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">volatile</span> <span class="cm-variable">Node</span> <span class="cm-variable">next</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">volatile</span> <span class="cm-variable">Thread</span> <span class="cm-variable">thread</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Node</span> <span class="cm-variable">nextWaiter</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">boolean</span> <span class="cm-variable">isShared</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">nextWaiter</span> <span class="cm-operator">==</span> <span class="cm-variable">SHARED</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Node</span> <span class="cm-variable">predecessor</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">NullPointerException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Node</span> <span class="cm-variable">p</span> <span class="cm-operator">=</span> <span class="cm-variable">prev</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">p</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">NullPointerException</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">p</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Node</span>() { &nbsp; &nbsp;<span class="cm-comment">// Used to establish initial head or SHARED marker</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Node</span>(<span class="cm-variable">Thread</span> <span class="cm-variable">thread</span>, <span class="cm-variable">Node</span> <span class="cm-variable">mode</span>) { &nbsp; &nbsp; <span class="cm-comment">// Used by addWaiter</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">nextWaiter</span> <span class="cm-operator">=</span> <span class="cm-variable">mode</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">thread</span> <span class="cm-operator">=</span> <span class="cm-variable">thread</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Node</span>(<span class="cm-variable">Thread</span> <span class="cm-variable">thread</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">waitStatus</span>) { <span class="cm-comment">// Used by Condition</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">waitStatus</span> <span class="cm-operator">=</span> <span class="cm-variable">waitStatus</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">thread</span> <span class="cm-operator">=</span> <span class="cm-variable">thread</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1386px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1386px;"></div></div></div></pre><h3><a name="23acquire方法" class="md-header-anchor"></a><span>2.3acquire方法</span></h3><p><span>获取独占锁的过程就是在acquire定义的，该方法用到了</span><strong><span>模板设计模式</span></strong><span>，由子类实现的~</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fce90e1e94ee3?w=1109&amp;h=508&amp;f=png&amp;s=23853" referrerpolicy="no-referrer"></p><p>&nbsp;</p><blockquote><p><span>过程：acquire(int)尝试获取资源，如果获取失败，将线程插入等待队列。插入等待队列后，acquire(int)并没有放弃获取资源，而是根据前置节点状态状态判断是否应该继续获取资源，如果前置节点是头结点，继续尝试获取资源，如果前置节点是SIGNAL状态，就中断当前线程，否则继续尝试获取资源。直到当前线程被park()或者获取到资源，acquire(int)结束。</span></p></blockquote><p><span>来源：</span></p><ul><li><a href='https://blog.csdn.net/panweiwei1994/article/details/78769703'><span>https://blog.csdn.net/panweiwei1994/article/details/78769703</span></a></li></ul><h3><a name="24release方法" class="md-header-anchor"></a><span>2.4release方法</span></h3><p><span>释放独占锁的过程就是在acquire定义的，该方法也用到了</span><strong><span>模板设计模式</span></strong><span>，由子类实现的~</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/25/162fce8ff20b8281?w=1133&amp;h=564&amp;f=png&amp;s=23757" referrerpolicy="no-referrer"></p><blockquote><p><span>过程:首先调用子类的tryRelease()方法释放锁,然后唤醒后继节点,在唤醒的过程中,需要判断后继节点是否满足情况,如果后继节点不为且不是作废状态,则唤醒这个后继节点,否则从tail节点向前寻找合适的节点,如果找到,则唤醒.</span></p></blockquote><p><span>来源：</span></p><ul><li><a href='https://zhuanlan.zhihu.com/p/27134110'><span>https://zhuanlan.zhihu.com/p/27134110</span></a></li></ul><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyv09urzj30730733ye.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><p>&nbsp;</p><h1><a name="六reentrantlock和reentrantreadwritelock" class="md-header-anchor"></a><span>六、ReentrantLock和ReentrantReadWriteLock</span></h1><p><span>上一篇已经将Lock锁的基础AQS简单地过了一遍了，因此本篇主要是讲解Lock锁主要的两个子类：</span></p><ul><li><span>ReentrantLock</span></li><li><span>ReentrantReadWriteLock</span></li></ul><p><span>那么接下来我们就开始吧~</span></p><h2><a name="一reentrantlock锁" class="md-header-anchor"></a><span>一、ReentrantLock锁</span></h2><p><span>首先我们来看看ReentrantLock锁的</span><strong><span>顶部注释</span></strong><span>，来看看他的相关特性呗：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a0c46db1c?w=1918&amp;h=2244&amp;f=png&amp;s=160925" referrerpolicy="no-referrer"></p><p><span>来总结一下要点吧：</span></p><ul><li><span>比synchronized更有伸缩性(灵活)</span></li><li><span>支持公平锁(是相对公平的)</span></li><li><span>使用时最标准用法是在try之前调用lock方法，在finally代码块释放锁</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">X</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">ReentrantLock</span> <span class="cm-variable">lock</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ReentrantLock</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// ...</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">m</span>() { </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lock</span>.<span class="cm-variable">lock</span>(); &nbsp;<span class="cm-comment">// block until condition holds</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// ... method body</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">finally</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">lock</span>.<span class="cm-variable">unlock</span>()</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><h3><a name="11内部类" class="md-header-anchor"></a><span>1.1内部类</span></h3><p><span>首先我们可以看到有三个内部类：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a0c3b99be?w=480&amp;h=99&amp;f=png&amp;s=3045" referrerpolicy="no-referrer"></p><p><span>这些内部类都是AQS的子类，这就印证了我们之前所说的：</span><strong><span>AQS是ReentrantLock的基础，AQS是构建锁、同步器的框架</span></strong></p><ul><li><span>可以很清晰的看到，我们的ReentrantLock锁是支持公平锁和非公平锁的~</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8b707f33d2?w=633&amp;h=556&amp;f=png&amp;s=8783" referrerpolicy="no-referrer"></p><h3><a name="12构造方法" class="md-header-anchor"></a><span>1.2构造方法</span></h3><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8b708ab8de?w=1154&amp;h=499&amp;f=png&amp;s=17103" referrerpolicy="no-referrer"></p><h3><a name="13非公平lock方法" class="md-header-anchor"></a><span>1.3非公平lock方法</span></h3><p><span>尝试获取锁，获取失败的话就调用AQS的</span><code>acquire(1)</code><span>方法</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a0c6c854a?w=1097&amp;h=367&amp;f=png&amp;s=18859" referrerpolicy="no-referrer"></p><p><code>acquire(1)</code><span>方法我们在AQS时简单看过，其中</span><code>tryAcquire()</code><span>是子类来实现的</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8b70fd41ad?w=944&amp;h=187&amp;f=png&amp;s=7329" referrerpolicy="no-referrer"></p><p><span>我们去看看</span><code>tryAcquire()</code><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8bc6662332?w=947&amp;h=508&amp;f=png&amp;s=18390" referrerpolicy="no-referrer"></p><h3><a name="14公平lock方法" class="md-header-anchor"></a><span>1.4公平lock方法</span></h3><p><span>公平的lock方法其实就</span><strong><span>多了一个状态条件</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8bff60c6c6?w=921&amp;h=520&amp;f=png&amp;s=15406" referrerpolicy="no-referrer"></p><p><span>这个方法主要是判断</span><strong><span>当前线程是否位于CLH同步队列中的第一个。如果是则返回flase，否则返回true</span></strong><span>。</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8c0ba010ab?w=1072&amp;h=311&amp;f=png&amp;s=14466" referrerpolicy="no-referrer"></p><h3><a name="15unlock方法" class="md-header-anchor"></a><span>1.5unlock方法</span></h3><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8c1d1ed219?w=1083&amp;h=410&amp;f=png&amp;s=13327" referrerpolicy="no-referrer"></p><p><span>unlock方法也是在AQS中定义的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8c6384be47?w=1007&amp;h=549&amp;f=png&amp;s=20183" referrerpolicy="no-referrer"></p><p><span>去看看</span><code>tryRelease(arg)</code><span>是怎么实现的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8c6eaf8064?w=906&amp;h=331&amp;f=png&amp;s=10262" referrerpolicy="no-referrer"></p><h2><a name="二reentrantreadwritelock" class="md-header-anchor"></a><span>二、ReentrantReadWriteLock</span></h2><p><span>我们知道synchronized内置锁和ReentrantLock都是</span><strong><span>互斥锁</span></strong><span>(一次只能有一个线程进入到临界区(被锁定的区域))</span></p><p><span>而ReentrantReadWriteLock是一个</span><strong><span>读写锁</span></strong><span>：</span></p><ul><li><span>在</span><strong><span>读</span></strong><span>取数据的时候，可以</span><strong><span>多个线程同时进入到到临界区</span></strong><span>(被锁定的区域)</span></li><li><span>在</span><strong><span>写</span></strong><span>数据的时候，无论是读线程还是写线程都是</span><strong><span>互斥</span></strong><span>的</span></li></ul><p><span>一般来说：我们大多数都是读取数据得多，修改数据得少。所以这个读写锁在这种场景下就很有用了！</span></p><p><span>读写锁有一个接口ReadWriteLock，定义的方法就两个：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a8c85c96a49?w=1448&amp;h=525&amp;f=png&amp;s=32007" referrerpolicy="no-referrer"></p><p><span>我们还是来看看顶部注释说得啥吧：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a0c8ad3f3?w=1918&amp;h=2487&amp;f=png&amp;s=202497" referrerpolicy="no-referrer"></p><p><span>其实大概也是说明了：</span><strong><span>在读的时候可以共享，在写的时候是互斥的</span></strong></p><p><span>接下来我们还是来看看对应的实现类吧：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a0c996d75?w=1003&amp;h=237&amp;f=png&amp;s=13232" referrerpolicy="no-referrer"></p><p><span>按照惯例也简单看看它的顶部注释：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305ab0dcf258c6?w=1918&amp;h=5160&amp;f=png&amp;s=323904" referrerpolicy="no-referrer"></p><p><span>于是我们可以总结出读写锁的一些要点了：</span></p><ul><li><span>读锁不支持条件对象，写锁支持条件对象</span></li><li><span>读锁不能升级为写锁，写锁可以降级为读锁</span></li><li><span>读写锁也有公平和非公平模式</span></li><li><strong><span>读锁支持多个读线程进入临界区，写锁是互斥的</span></strong></li></ul><h3><a name="21reentrantreadwritelock内部类" class="md-header-anchor"></a><span>2.1ReentrantReadWriteLock内部类</span></h3><p><span>ReentrantReadWriteLock比ReentrantLock锁</span><strong><span>多了两个内部类(都是Lock实现)来维护读锁和写锁</span></strong><span>，但是</span><strong><span>主体还是使用Syn</span></strong><span>：</span></p><ul><li><span>WriteLock</span></li><li><span>ReadLock</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a3e20057d?w=471&amp;h=458&amp;f=png&amp;s=13693" referrerpolicy="no-referrer"></p><h3><a name="22读锁和写锁的状态表示" class="md-header-anchor"></a><span>2.2读锁和写锁的状态表示</span></h3><p><span>在ReentrantLock锁上使用的是state来表示同步状态(也可以表示重入的次数)，而在ReentrantReadWriteLock是这样代表读写状态的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a5498faf6?w=1133&amp;h=481&amp;f=png&amp;s=21898" referrerpolicy="no-referrer"></p><h3><a name="23写锁的获取" class="md-header-anchor"></a><span>2.3写锁的获取</span></h3><p><span>主要还是调用syn的</span><code>acquire(1)</code><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a7250f521?w=1378&amp;h=243&amp;f=png&amp;s=21190" referrerpolicy="no-referrer"></p><p><span>进去看看实现：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a813cc19a?w=993&amp;h=706&amp;f=png&amp;s=35308" referrerpolicy="no-referrer"></p><h3><a name="24读锁获取" class="md-header-anchor"></a><span>2.4读锁获取</span></h3><p><span>写锁的获取调用的是</span><code>acquireShared(int arg)</code><span>方法：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305a9a898d6327?w=1148&amp;h=442&amp;f=png&amp;s=16837" referrerpolicy="no-referrer"></p><p><span>内部调用的是：</span><code>doAcquireShared(arg);</code><span>方法(实现也是在Syn的)，我们来看看：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/27/16305aabad5236dd?w=1918&amp;h=1497&amp;f=png&amp;s=92898" referrerpolicy="no-referrer"></p><h2><a name="三最后" class="md-header-anchor"></a><span>三、最后</span></h2><p><span>这里就简单总结一下本文的内容吧：</span></p><ul><li><strong><span>AQS是</span></strong><span>ReentrantReadWriteLock和ReentrantLock的</span><strong><span>基础</span></strong><span>，因为默认的实现都是在内部类Syn中，而Syn是继承AQS的~</span></li><li><span>ReentrantReadWriteLock和ReentrantLock</span><strong><span>都支持公平和非公平模式</span></strong><span>，公平模式下会去看FIFO队列线程是否是在队头，而非公平模式下是没有的</span></li><li><span>ReentrantReadWriteLock是一个读写锁，如果读的线程比写的线程要多很多的话，那可以考虑使用它。它使用state的变量</span><strong><span>高16位是读锁，低16位是写锁</span></strong></li><li><strong><span>写锁可以降级为读锁，读锁不能升级为写锁</span></strong></li><li><strong><span>写锁是互斥的，读锁是共享的</span></strong><span>。</span></li></ul><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyxk0p5kj3073073glh.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h1><a name="七线程池" class="md-header-anchor"></a><span>七、线程池</span></h1><p>&nbsp;</p><h2><a name="一线程池简介" class="md-header-anchor"></a><span>一、线程池简介</span></h2><p><span>线程池可以看做是</span><strong><span>线程的集合</span></strong><span>。在没有任务时线程处于空闲状态，当请求到来：线程池给这个请求分配一个空闲的线程，任务完成后回到线程池中等待下次任务</span><strong><span>(而不是销毁)</span></strong><span>。这样就</span><strong><span>实现了线程的重用</span></strong><span>。</span></p><p><span>我们来看看</span><strong><span>如果没有使用线程池</span></strong><span>的情况是这样的：</span></p><ul><li><strong><span>为每个请求都新开一个线程</span></strong><span>！</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">ThreadPerTaskWebServer</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">IOException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ServerSocket</span> <span class="cm-variable">socket</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ServerSocket</span>(<span class="cm-number">80</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">while</span> (<span class="cm-atom">true</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 为每个请求都创建一个新的线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Socket</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">socket</span>.<span class="cm-variable">accept</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Runnable</span> <span class="cm-variable">task</span> <span class="cm-operator">=</span> () <span class="cm-operator">-&gt;</span> <span class="cm-variable">handleRequest</span>(<span class="cm-variable">connection</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-variable">task</span>).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">handleRequest</span>(<span class="cm-variable">Socket</span> <span class="cm-variable">connection</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// request-handling logic here</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>为每个请求都开一个新的线程虽然</span><strong><span>理论上是可以</span></strong><span>的，但是会有</span><strong><span>缺点</span></strong><span>：</span></p><ul><li><strong><span>线程生命周期的开销非常高</span></strong><span>。每个线程都有自己的生命周期，</span><strong><span>创建和销毁线程</span></strong><span>所花费的时间和资源可能比处理客户端的任务花费的时间和资源更多，并且还会有某些</span><strong><span>空闲线程也会占用资源</span></strong><span>。</span></li><li><span>程序的稳定性和健壮性会下降，每个请求开一个线程。如果受到了恶意攻击或者请求过多(内存不足)，程序很容易就奔溃掉了。</span></li></ul><p><span>所以说：我们的</span><strong><span>线程最好是交由线程池来管理</span></strong><span>，这样可以减少对线程生命周期的管理，一定程度上提高性能。</span></p><h2><a name="二jdk提供的线程池api" class="md-header-anchor"></a><span>二、JDK提供的线程池API</span></h2><p><span>JDK给我们提供了</span><strong><span>Excutor框架</span></strong><span>来使用线程池，它是</span><strong><span>线程池的基础</span></strong><span>。</span></p><ul><li><span>Executor提供了一种将</span><strong><span>“任务提交”与“任务执行”</span></strong><span>分离开来的机制(解耦)</span></li></ul><p><span>下面我们来看看JDK线程池的总体api架构：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330918d3dbf6ad?w=1003&amp;h=708&amp;f=png&amp;s=18678" referrerpolicy="no-referrer"></p><p><span>接下来我们把这些API都过一遍看看：</span></p><p><span>Executor接口：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330918d5167cf2?w=1211&amp;h=475&amp;f=png&amp;s=18061" referrerpolicy="no-referrer"></p><p><span>ExcutorService接口：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330918d3fb596e?w=1680&amp;h=681&amp;f=png&amp;s=59550" referrerpolicy="no-referrer"></p><p><span>AbstractExecutorService类：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330918d52464ff?w=1799&amp;h=708&amp;f=png&amp;s=54483" referrerpolicy="no-referrer"></p><p><span>ScheduledExecutorService接口：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330918dedf5285?w=1599&amp;h=592&amp;f=png&amp;s=42304" referrerpolicy="no-referrer"></p><p><strong><span>ThreadPoolExecutor类：</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330918d5783349?w=1657&amp;h=782&amp;f=png&amp;s=73397" referrerpolicy="no-referrer"></p><p><strong><span>ScheduledThreadPoolExecutor类：</span></strong></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091998cee0e2?w=1702&amp;h=730&amp;f=png&amp;s=63207" referrerpolicy="no-referrer"></p><h3><a name="21forkjoinpool线程池" class="md-header-anchor"></a><span>2.1ForkJoinPool线程池</span></h3><p><span>除了ScheduledThreadPoolExecutor和ThreadPoolExecutor类线程池以外，还有一个是</span><strong><span>JDK1.7新增</span></strong><span>的线程池：ForkJoinPool线程池</span></p><p><span>于是我们的类图就可以变得完整一些：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091998bf88ce?w=800&amp;h=596&amp;f=png&amp;s=14246" referrerpolicy="no-referrer"></p><blockquote><p><span>JDK1.7中新增的一个线程池，与ThreadPoolExecutor一样，同样继承了AbstractExecutorService。ForkJoinPool是Fork/Join框架的两大核心类之一。与其它类型的ExecutorService相比，</span><strong><span>其主要的不同在于采用了工作窃取算法(work-stealing)</span></strong><span>：所有池中线程会尝试找到并执行已被提交到池中的或由其他线程创建的任务。这样很少有线程会处于空闲状态，非常高效。这使得能够有效地处理以下情景：</span><strong><span>大多数由任务产生大量子任务的情况</span></strong><span>；从外部客户端大量提交小任务到池中的情况。</span></p></blockquote><p><span>来源：</span></p><ul><li><a href='https://blog.csdn.net/panweiwei1994/article/details/78969238'><span>https://blog.csdn.net/panweiwei1994/article/details/78969238</span></a></li></ul><h3><a name="22补充callable和future" class="md-header-anchor"></a><span>2.2补充：Callable和Future</span></h3><p><span>学到了线程池，我们可以很容易地发现：很多的API都有Callable和Future这么两个东西。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Future</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-def">submit</span>(<span class="cm-variable">Runnable</span> <span class="cm-variable">task</span>)</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">Future</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-def">submit</span>(<span class="cm-variable">Callable</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">task</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 44px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p><span>其实它们也不是什么高深的东西~~~</span></p><p><span>我们可以简单认为：</span><strong><span>Callable就是Runnable的扩展</span></strong><span>。</span></p><ul><li><strong><span>Runnable没有返回值，不能抛出受检查的异常，而Callable可以</span></strong><span>！</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330919e74eb356?w=975&amp;h=331&amp;f=png&amp;s=8889" referrerpolicy="no-referrer"></p><p><span>也就是说：当我们的</span><strong><span>任务需要返回值</span></strong><span>的时，我们就可以使用Callable！</span></p><p><span>Future一般我们认为是Callable的返回值，但他其实代表的是</span><strong><span>任务的生命周期</span></strong><span>(当然了，它是能获取得到Callable的返回值的)</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330919a84c2a25?w=1189&amp;h=353&amp;f=png&amp;s=24749" referrerpolicy="no-referrer"></p><p><span>简单来看一下他们的用法：</span></p><p>&nbsp;</p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">CallableDemo</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">InterruptedException</span>, <span class="cm-variable">ExecutionException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 创建线程池对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">ExecutorService</span> <span class="cm-variable">pool</span> <span class="cm-operator">=</span> <span class="cm-variable">Executors</span>.<span class="cm-variable">newFixedThreadPool</span>(<span class="cm-number">2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 可以执行Runnable对象或者Callable对象代表的线程</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Future</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">Integer</span><span class="cm-operator">&gt;</span> <span class="cm-variable">f1</span> <span class="cm-operator">=</span> <span class="cm-variable">pool</span>.<span class="cm-variable">submit</span>(<span class="cm-keyword">new</span> <span class="cm-variable">MyCallable</span>(<span class="cm-number">100</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">Future</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">Integer</span><span class="cm-operator">&gt;</span> <span class="cm-variable">f2</span> <span class="cm-operator">=</span> <span class="cm-variable">pool</span>.<span class="cm-variable">submit</span>(<span class="cm-keyword">new</span> <span class="cm-variable">MyCallable</span>(<span class="cm-number">200</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// V get()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">Integer</span> <span class="cm-variable">i1</span> <span class="cm-operator">=</span> <span class="cm-variable">f1</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">Integer</span> <span class="cm-variable">i2</span> <span class="cm-operator">=</span> <span class="cm-variable">f2</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">i1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">i2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 结束</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">pool</span>.<span class="cm-variable">shutdown</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 440px;"></div><div class="CodeMirror-gutters" style="display: none; height: 440px;"></div></div></div></pre><p><span>Callable任务：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyCallable</span> <span class="cm-keyword">implements</span> <span class="cm-variable">Callable</span><span class="cm-operator">&lt;</span><span class="cm-variable-3">Integer</span><span class="cm-operator">&gt;</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">private</span> <span class="cm-variable-3">int</span> <span class="cm-variable">number</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable">MyCallable</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">number</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">this</span>.<span class="cm-variable">number</span> <span class="cm-operator">=</span> <span class="cm-variable">number</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">public</span> <span class="cm-variable-3">Integer</span> <span class="cm-variable">call</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">Exception</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable-3">int</span> <span class="cm-variable">sum</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">x</span> <span class="cm-operator">=</span> <span class="cm-number">1</span>; <span class="cm-variable">x</span> <span class="cm-operator">&lt;=</span> <span class="cm-variable">number</span>; <span class="cm-variable">x</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">sum</span> <span class="cm-operator">+=</span> <span class="cm-variable">x</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-keyword">return</span> <span class="cm-variable">sum</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span>}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 418px;"></div><div class="CodeMirror-gutters" style="display: none; height: 418px;"></div></div></div></pre><p><span>执行完任务之后可以</span><strong><span>获取得到任务返回的数据</span></strong><span>：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330919b373dd8a?w=732&amp;h=215&amp;f=png&amp;s=4870" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnywo71jrg308c08caa4.gif" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h2><a name="三threadpoolexecutor详解" class="md-header-anchor"></a><span>三、ThreadPoolExecutor详解</span></h2><p><span>这是用得最多的线程池，所以本文会重点讲解它。</span></p><p><span>我们来看看顶部注释：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/16330919d52fa1f8?w=1533&amp;h=4685&amp;f=jpeg&amp;s=927724" referrerpolicy="no-referrer"></p><h3><a name="31内部状态" class="md-header-anchor"></a><span>3.1内部状态</span></h3><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091a7df162af?w=1119&amp;h=191&amp;f=png&amp;s=8360" referrerpolicy="no-referrer"></p><p><span>变量ctl定义为AtomicInteger，</span><strong><span>记录了“线程池中的任务数量”和“线程池的状态”两个信息</span></strong><span>。</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091a51628023?w=1097&amp;h=724&amp;f=png&amp;s=29373" referrerpolicy="no-referrer"></p><p><span>线程的状态：</span></p><ul><li><span>RUNNING：线程池</span><strong><span>能够接受新任务</span></strong><span>，以及对新添加的任务进行处理。</span></li><li><span>SHUTDOWN：线程池</span><strong><span>不可以接受新任务</span></strong><span>，但是可以对已添加的任务进行处理。</span></li><li><span>STOP：线程池</span><strong><span>不接收新任务，不处理已添加的任务，并且会中断正在处理的任务</span></strong><span>。</span></li><li><span>TIDYING：当</span><strong><span>所有的任务已终止</span></strong><span>，ctl记录的&quot;任务数量&quot;为0，线程池会变为TIDYING状态。当线程池变为TIDYING状态时，会执行钩子函数terminated()。terminated()在ThreadPoolExecutor类中是空的，若用户想在线程池变为TIDYING时，进行相应的处理；可以通过重载terminated()函数来实现。</span></li><li><span>TERMINATED：线程池</span><strong><span>彻底终止的状态</span></strong><span>。</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091a841450d9?w=1064&amp;h=372&amp;f=png&amp;s=17003" referrerpolicy="no-referrer"></p><p><span>各个状态之间转换：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091adfc9d89e?w=922&amp;h=348&amp;f=png&amp;s=37225" referrerpolicy="no-referrer"></p><h3><a name="32已默认实现的池" class="md-header-anchor"></a><span>3.2已默认实现的池</span></h3><p><span>下面我就列举三个比较</span><strong><span>常见</span></strong><span>的实现池：</span></p><ul><li><span>newFixedThreadPool</span></li><li><span>newCachedThreadPool</span></li><li><span>SingleThreadExecutor</span></li></ul><p><span>如果读懂了上面对应的策略呀，线程数量这些，应该就不会太难看懂了。</span></p><h4><a name="321newfixedthreadpool" class="md-header-anchor"></a><span>3.2.1newFixedThreadPool</span></h4><p><span>一个固定线程数的线程池，它将返回一个</span><strong><span>corePoolSize和maximumPoolSize相等的线程池</span></strong><span>。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; <span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">ExecutorService</span> <span class="cm-def">newFixedThreadPool</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">nThreads</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">ThreadPoolExecutor</span>(<span class="cm-variable">nThreads</span>, <span class="cm-variable">nThreads</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0L</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">MILLISECONDS</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">LinkedBlockingQueue</span><span class="cm-operator">&lt;</span><span class="cm-variable">Runnable</span><span class="cm-operator">&gt;</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><h4><a name="322newcachedthreadpool" class="md-header-anchor"></a><span>3.2.2newCachedThreadPool</span></h4><p><strong><span>非常有弹性的线程池</span></strong><span>，对于新的任务，如果此时线程池里没有空闲线程，</span><strong><span>线程池会毫不犹豫的创建一条新的线程去处理这个任务</span></strong><span>。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">ExecutorService</span> <span class="cm-def">newCachedThreadPool</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">ThreadPoolExecutor</span>(<span class="cm-number">0</span>, <span class="cm-variable-3">Integer</span>.<span class="cm-variable">MAX_VALUE</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">60L</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">SECONDS</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">SynchronousQueue</span><span class="cm-operator">&lt;</span><span class="cm-variable">Runnable</span><span class="cm-operator">&gt;</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><h4><a name="323singlethreadexecutor" class="md-header-anchor"></a><span>3.2.3SingleThreadExecutor</span></h4><p><strong><span>使用单个worker线程的Executor</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">ExecutorService</span> <span class="cm-def">newSingleThreadExecutor</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">FinalizableDelegatedExecutorService</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  (<span class="cm-keyword">new</span> <span class="cm-variable">ThreadPoolExecutor</span>(<span class="cm-number">1</span>, <span class="cm-number">1</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-number">0L</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">MILLISECONDS</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">LinkedBlockingQueue</span><span class="cm-operator">&lt;</span><span class="cm-variable">Runnable</span><span class="cm-operator">&gt;</span>()));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 132px;"></div><div class="CodeMirror-gutters" style="display: none; height: 132px;"></div></div></div></pre><h3><a name="33构造方法" class="md-header-anchor"></a><span>3.3构造方法</span></h3><p><span>我们读完上面的默认实现池还有对应的属性，再回到构造方法看看</span></p><ul><li><span>构造方法可以让我们</span><strong><span>自定义(扩展)线程池</span></strong></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">ThreadPoolExecutor</span>(<span class="cm-variable-3">int</span> <span class="cm-variable">corePoolSize</span>,</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">maximumPoolSize</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">long</span> <span class="cm-variable">keepAliveTime</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">TimeUnit</span> <span class="cm-variable">unit</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">BlockingQueue</span><span class="cm-operator">&lt;</span><span class="cm-variable">Runnable</span><span class="cm-operator">&gt;</span> <span class="cm-variable">workQueue</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ThreadFactory</span> <span class="cm-variable">threadFactory</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">RejectedExecutionHandler</span> <span class="cm-variable">handler</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">corePoolSize</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span> <span class="cm-operator">||</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">maximumPoolSize</span> <span class="cm-operator">&lt;=</span> <span class="cm-number">0</span> <span class="cm-operator">||</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">maximumPoolSize</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">corePoolSize</span> <span class="cm-operator">||</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">keepAliveTime</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">IllegalArgumentException</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">workQueue</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span> <span class="cm-operator">||</span> <span class="cm-variable">threadFactory</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span> <span class="cm-operator">||</span> <span class="cm-variable">handler</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">NullPointerException</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">corePoolSize</span> <span class="cm-operator">=</span> <span class="cm-variable">corePoolSize</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">maximumPoolSize</span> <span class="cm-operator">=</span> <span class="cm-variable">maximumPoolSize</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">workQueue</span> <span class="cm-operator">=</span> <span class="cm-variable">workQueue</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">keepAliveTime</span> <span class="cm-operator">=</span> <span class="cm-variable">unit</span>.<span class="cm-variable">toNanos</span>(<span class="cm-variable">keepAliveTime</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">threadFactory</span> <span class="cm-operator">=</span> <span class="cm-variable">threadFactory</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">handler</span> <span class="cm-operator">=</span> <span class="cm-variable">handler</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;"></div><div class="CodeMirror-gutters" style="display: none; height: 462px;"></div></div></div></pre><ol><li><span>指定核心线程数量</span></li><li><span>指定最大线程数量</span></li><li><span>允许线程空闲时间</span></li><li><span>时间对象</span></li><li><span>阻塞队列</span></li><li><span>线程工厂</span></li><li><span>任务拒绝策略</span></li></ol><p><span>再总结一遍这些参数的要点：</span></p><p><strong><span>线程数量要点</span></strong><span>：</span></p><ul><li><span>如果运行线程的数量</span><strong><span>少于</span></strong><span>核心线程数量，则</span><strong><span>创建新</span></strong><span>的线程处理请求</span></li><li><span>如果运行线程的数量</span><strong><span>大于</span></strong><span>核心线程数量，</span><strong><span>小于</span></strong><span>最大线程数量，则当</span><strong><span>队列满的时候才创建新</span></strong><span>的线程</span></li><li><span>如果核心线程数量</span><strong><span>等于</span></strong><span>最大线程数量，那么将</span><strong><span>创建固定大小</span></strong><span>的连接池</span></li><li><span>如果设置了最大线程数量为</span><strong><span>无穷</span></strong><span>，那么允许线程池适合</span><strong><span>任意</span></strong><span>的并发数量</span></li></ul><p><strong><span>线程空闲时间要点：</span></strong></p><ul><li><span>当前线程数</span><strong><span>大于</span></strong><span>核心线程数，如果空闲时间已经超过了，那该线程会</span><strong><span>销毁</span></strong><span>。</span></li></ul><p><strong><span>排队策略要点</span></strong><span>：</span></p><ul><li><span>同步移交：</span><strong><span>不会放到队列中，而是等待线程执行它</span></strong><span>。如果当前线程没有执行，很可能会</span><strong><span>新开</span></strong><span>一个线程执行。</span></li><li><span>无界限策略：</span><strong><span>如果核心线程都在工作，该线程会放到队列中</span></strong><span>。所以线程数不会超过核心线程数</span></li><li><span>有界限策略：</span><strong><span>可以避免资源耗尽</span></strong><span>，但是一定程度上减低了吞吐量</span></li></ul><p><span>当线程关闭或者线程数量满了和队列饱和了，就有拒绝任务的情况了：</span></p><p><strong><span>拒绝任务策略：</span></strong></p><ul><li><span>直接抛出异常</span></li><li><span>使用调用者的线程来处理</span></li><li><span>直接丢掉这个任务</span></li><li><span>丢掉最老的任务</span></li></ul><h2><a name="四execute执行方法" class="md-header-anchor"></a><span>四、execute执行方法</span></h2><p><span>execute执行方法分了三步，以注释的方式写在代码上了~</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">execute</span>(<span class="cm-variable">Runnable</span> <span class="cm-variable">command</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">command</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">NullPointerException</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">ctl</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//如果线程池中运行的线程数量&lt;corePoolSize，则创建新线程来处理请求，即使其他辅助线程是空闲的。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">workerCountOf</span>(<span class="cm-variable">c</span>) <span class="cm-operator">&lt;</span> <span class="cm-variable">corePoolSize</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">addWorker</span>(<span class="cm-variable">command</span>, <span class="cm-atom">true</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">ctl</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//如果线程池中运行的线程数量&gt;=corePoolSize，且线程池处于RUNNING状态，且把提交的任务成功放入阻塞队列中，就再次检查线程池的状态，</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 1.如果线程池不是RUNNING状态，且成功从阻塞队列中删除任务，则该任务由当前 RejectedExecutionHandler 处理。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 2.否则如果线程池中运行的线程数量为0，则通过addWorker(null, false)尝试新建一个线程，新建线程对应的任务为null。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">isRunning</span>(<span class="cm-variable">c</span>) <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">workQueue</span>.<span class="cm-variable">offer</span>(<span class="cm-variable">command</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">recheck</span> <span class="cm-operator">=</span> <span class="cm-variable">ctl</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-operator">!</span> <span class="cm-variable">isRunning</span>(<span class="cm-variable">recheck</span>) <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable">remove</span>(<span class="cm-variable">command</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">reject</span>(<span class="cm-variable">command</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">workerCountOf</span>(<span class="cm-variable">recheck</span>) <span class="cm-operator">==</span> <span class="cm-number">0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">addWorker</span>(<span class="cm-atom">null</span>, <span class="cm-atom">false</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 如果以上两种case不成立，即没能将任务成功放入阻塞队列中，且addWoker新建线程失败，则该任务由当前 RejectedExecutionHandler 处理。</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable">addWorker</span>(<span class="cm-variable">command</span>, <span class="cm-atom">false</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">reject</span>(<span class="cm-variable">command</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 638px;"></div><div class="CodeMirror-gutters" style="display: none; height: 638px;"></div></div></div></pre><h2><a name="五线程池关闭" class="md-header-anchor"></a><span>五、线程池关闭</span></h2><p><span>ThreadPoolExecutor提供了</span><code>shutdown()</code><span>和</span><code>shutdownNow()</code><span>两个方法来关闭线程池</span></p><p><span>shutdown() ：</span>
<img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091b0763388d?w=1186&amp;h=683&amp;f=png&amp;s=36457" referrerpolicy="no-referrer"></p><p><span>shutdownNow():</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/5/5/1633091b0a764a07?w=1382&amp;h=849&amp;f=png&amp;s=55052" referrerpolicy="no-referrer"></p><p>&nbsp;</p><p><strong><span>区别：</span></strong></p><ul><li><span>调用shutdown()后，线程池状态立刻</span><strong><span>变为SHUTDOWN</span></strong><span>，而调用shutdownNow()，线程池状态</span><strong><span>立刻变为STOP</span></strong><span>。</span></li><li><span>shutdown()</span><strong><span>等待任务执行完</span></strong><span>才中断线程，而shutdownNow()</span><strong><span>不等任务执行完</span></strong><span>就中断了线程。</span></li></ul><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyv09urzj30730733ye.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h1><a name="八死锁" class="md-header-anchor"></a><span>八、死锁</span></h1><p>&nbsp;</p><h2><a name="一死锁讲解" class="md-header-anchor"></a><span>一、死锁讲解</span></h2><p><span>在Java中使用多线程，就会</span><strong><span>有可能导致死锁</span></strong><span>问题。死锁会让程序一直</span><strong><span>卡</span></strong><span>住，不再程序往下执行。我们只能通过</span><strong><span>中止并重启</span></strong><span>的方式来让程序重新执行。</span></p><ul><li><span>这是我们非常不愿意看到的一种现象，我们要</span><strong><span>尽可能</span></strong><span>避免死锁的情况发生！</span></li></ul><p><span>造成死锁的原因可以</span><strong><span>概括</span></strong><span>成三句话：</span></p><ul><li><span>当前线程</span><strong><span>拥有其他线程需要的</span></strong><span>资源</span></li><li><span>当前线程</span><strong><span>等待其他线程已拥有</span></strong><span>的资源</span></li><li><strong><span>都不放弃</span></strong><span>自己拥有的资源</span></li></ul><h3><a name="11锁顺序死锁" class="md-header-anchor"></a><span>1.1锁顺序死锁</span></h3><p><span>首先我们来看一下最简单的死锁(锁顺序死锁)是怎么样发生的：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">LeftRightDeadlock</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">left</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">Object</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">right</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">Object</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">leftRight</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 得到left锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">left</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 得到right锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">right</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">doSomething</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">rightLeft</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 得到right锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">right</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 得到left锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">left</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">doSomethingElse</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 528px;"></div><div class="CodeMirror-gutters" style="display: none; height: 528px;"></div></div></div></pre><p><span>我们的线程是</span><strong><span>交错执行</span></strong><span>的，那么就很有可能出现以下的情况：</span></p><ul><li><span>线程A调用</span><code>leftRight()</code><span>方法，得到left锁</span></li><li><strong><span>同时</span></strong><span>线程B调用</span><code>rightLeft()</code><span>方法，得到right锁</span></li><li><span>线程A和线程B都继续执行，此时线程A需要right锁</span><strong><span>才能继续往下</span></strong><span>执行。此时线程B需要left锁</span><strong><span>才能继续往下</span></strong><span>执行。</span></li><li><span>但是：</span><strong><span>线程A的left锁并没有释放，线程B的right锁也没有释放</span></strong><span>。</span></li><li><span>所以他们都只能等待，而这种等待是无期限的--&gt;永久等待--&gt;死锁</span></li></ul><p><img src="https://user-gold-cdn.xitu.io/2018/5/6/163350c1153053c4?w=3264&amp;h=2448&amp;f=jpeg&amp;s=564724" referrerpolicy="no-referrer"></p><h3><a name="12动态锁顺序死锁" class="md-header-anchor"></a><span>1.2动态锁顺序死锁</span></h3><p><span>我们看一下下面的例子，你认为会发生死锁吗？</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 转账</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-def">transferMoney</span>(<span class="cm-variable">Account</span> <span class="cm-variable">fromAccount</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">Account</span> <span class="cm-variable">toAccount</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">DollarAmount</span> <span class="cm-variable">amount</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throws</span> <span class="cm-variable">InsufficientFundsException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 锁定汇账账户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">fromAccount</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 锁定来账账户</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">toAccount</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 判余额是否大于0</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">fromAccount</span>.<span class="cm-variable">getBalance</span>().<span class="cm-variable">compareTo</span>(<span class="cm-variable">amount</span>) <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">InsufficientFundsException</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 汇账账户减钱</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">fromAccount</span>.<span class="cm-variable">debit</span>(<span class="cm-variable">amount</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 来账账户增钱</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">toAccount</span>.<span class="cm-variable">credit</span>(<span class="cm-variable">amount</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 550px;"></div><div class="CodeMirror-gutters" style="display: none; height: 550px;"></div></div></div></pre><p><span>上面的代码</span><strong><span>看起来是没有问题的</span></strong><span>：锁定两个账户来判断余额是否充足才进行转账！</span></p><p><span>但是，同样</span><strong><span>有可能会发生死锁</span></strong><span>：</span></p><ul><li><span>如果两个线程</span><strong><span>同时</span></strong><span>调用</span><code>transferMoney()</code></li><li><span>线程A从X账户向Y账户转账</span></li><li><span>线程B从账户Y向账户X转账</span></li><li><span>那么就会发生死锁。</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">A</span>:<span class="cm-variable">transferMoney</span>(<span class="cm-variable">myAccount</span>,<span class="cm-variable">yourAccount</span>,<span class="cm-number">10</span>);</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">B</span>:<span class="cm-variable">transferMoney</span>(<span class="cm-variable">yourAccount</span>,<span class="cm-variable">myAccount</span>,<span class="cm-number">20</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 110px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><h3><a name="13协作对象之间发生死锁" class="md-header-anchor"></a><span>1.3协作对象之间发生死锁</span></h3><p><span>我们来看一下下面的例子：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">CooperatingDeadlock</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// Warning: deadlock-prone!</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Taxi</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@GuardedBy</span>(<span class="cm-string">"this"</span>) <span class="cm-keyword">private</span> <span class="cm-variable">Point</span> <span class="cm-variable">location</span>, <span class="cm-variable">destination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Dispatcher</span> <span class="cm-variable">dispatcher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Taxi</span>(<span class="cm-variable">Dispatcher</span> <span class="cm-variable">dispatcher</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">dispatcher</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatcher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable">Point</span> <span class="cm-variable">getLocation</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">location</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// setLocation 需要Taxi内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setLocation</span>(<span class="cm-variable">Point</span> <span class="cm-variable">location</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">location</span> <span class="cm-operator">=</span> <span class="cm-variable">location</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">location</span>.<span class="cm-variable">equals</span>(<span class="cm-variable">destination</span>))</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 调用notifyAvailable()需要Dispatcher内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatcher</span>.<span class="cm-variable">notifyAvailable</span>(<span class="cm-keyword">this</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable">Point</span> <span class="cm-variable">getDestination</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">destination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setDestination</span>(<span class="cm-variable">Point</span> <span class="cm-variable">destination</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">destination</span> <span class="cm-operator">=</span> <span class="cm-variable">destination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Dispatcher</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@GuardedBy</span>(<span class="cm-string">"this"</span>) <span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span> <span class="cm-variable">taxis</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@GuardedBy</span>(<span class="cm-string">"this"</span>) <span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span> <span class="cm-variable">availableTaxis</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Dispatcher</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">taxis</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">availableTaxis</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">notifyAvailable</span>(<span class="cm-variable">Taxi</span> <span class="cm-variable">taxi</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">availableTaxis</span>.<span class="cm-variable">add</span>(<span class="cm-variable">taxi</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 调用getImage()需要Dispatcher内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable">Image</span> <span class="cm-variable">getImage</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Image</span> <span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Image</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">Taxi</span> <span class="cm-variable">t</span> : <span class="cm-variable">taxis</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 调用getLocation()需要Taxi内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">image</span>.<span class="cm-variable">drawMarker</span>(<span class="cm-variable">t</span>.<span class="cm-variable">getLocation</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">image</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Image</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">drawMarker</span>(<span class="cm-variable">Point</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1298px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1298px;"></div></div></div></pre><p><span>上面的</span><code>getImage()</code><span>和</span><code>setLocation(Point location)</code><span>都需要获取两个锁的</span></p><ul><li><span>并且在操作</span><strong><span>途中是没有释放锁的</span></strong></li></ul><p><span>这就是</span><strong><span>隐式获取两个锁</span></strong><span>(对象之间协作)..</span></p><p><span>这种方式</span><strong><span>也很容易就造成死锁</span></strong><span>.....</span></p><h2><a name="二避免死锁的方法" class="md-header-anchor"></a><span>二、避免死锁的方法</span></h2><p><span>避免死锁可以概括成三种方法：</span></p><ul><li><p><strong><span>固定加锁的顺序</span></strong><span>(针对锁顺序死锁)</span></p></li><li><p><strong><span>开放调用</span></strong><span>(针对对象之间协作造成的死锁)</span></p></li><li><p><strong><span>使用定时锁</span></strong><span>--&gt;</span><code>tryLock()</code></p><ul><li><span>如果等待获取锁时间超时，则</span><strong><span>抛出异常而不是一直等待</span></strong><span>！</span></li></ul></li></ul><h3><a name="21固定锁顺序避免死锁" class="md-header-anchor"></a><span>2.1固定锁顺序避免死锁</span></h3><p><span>上面</span><code>transferMoney()</code><span>发生死锁的原因是因为</span><strong><span>加锁顺序</span></strong><span>不一致而出现的~</span></p><ul><li><span>正如书上所说的：如果所有线程</span><strong><span>以固定的顺序来获得锁</span></strong><span>，那么程序中就不会出现锁顺序死锁问题！</span></li></ul><p><span>那么上面的例子我们就可以</span><strong><span>改造</span></strong><span>成这样子：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">InduceLockOrder</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 额外的锁、避免两个对象hash值相等的情况(即使很少)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">Object</span> <span class="cm-variable">tieLock</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">Object</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">transferMoney</span>(<span class="cm-keyword">final</span> <span class="cm-variable">Account</span> <span class="cm-variable">fromAcct</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">Account</span> <span class="cm-variable">toAcct</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">DollarAmount</span> <span class="cm-variable">amount</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throws</span> <span class="cm-variable">InsufficientFundsException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Helper</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">transfer</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">InsufficientFundsException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">fromAcct</span>.<span class="cm-variable">getBalance</span>().<span class="cm-variable">compareTo</span>(<span class="cm-variable">amount</span>) <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">InsufficientFundsException</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">fromAcct</span>.<span class="cm-variable">debit</span>(<span class="cm-variable">amount</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">toAcct</span>.<span class="cm-variable">credit</span>(<span class="cm-variable">amount</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 得到锁的hash值</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">fromHash</span> <span class="cm-operator">=</span> <span class="cm-variable">System</span>.<span class="cm-variable">identityHashCode</span>(<span class="cm-variable">fromAcct</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">toHash</span> <span class="cm-operator">=</span> <span class="cm-variable">System</span>.<span class="cm-variable">identityHashCode</span>(<span class="cm-variable">toAcct</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 根据hash值来上锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">fromHash</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">toHash</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">fromAcct</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">toAcct</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Helper</span>().<span class="cm-variable">transfer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> <span class="cm-keyword">if</span> (<span class="cm-variable">fromHash</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">toHash</span>) {<span class="cm-comment">// 根据hash值来上锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">toAcct</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">fromAcct</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Helper</span>().<span class="cm-variable">transfer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {<span class="cm-comment">// 额外的锁、避免两个对象hash值相等的情况(即使很少)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">tieLock</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">fromAcct</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">toAcct</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Helper</span>().<span class="cm-variable">transfer</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1056px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1056px;"></div></div></div></pre><p><span>得到对应的</span><strong><span>hash值来固定加锁的顺序</span></strong><span>，这样我们就不会发生死锁的问题了！</span></p><h3><a name="22开放调用避免死锁" class="md-header-anchor"></a><span>2.2开放调用避免死锁</span></h3><p><span>在协作对象之间发生死锁的例子中，主要是因为在</span><strong><span>调用某个方法时就需要持有锁</span></strong><span>，并且在方法内部也调用了其他带锁的方法！</span></p><ul><li><strong><span>如果在调用某个方法时不需要持有锁，那么这种调用被称为开放调用</span></strong><span>！</span></li></ul><p><span>我们可以这样来改造：</span></p><ul><li><span>同步代码块最好</span><strong><span>仅被用于保护那些涉及共享状态的操作</span></strong><span>！</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">CooperatingNoDeadlock</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@ThreadSafe</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Taxi</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@GuardedBy</span>(<span class="cm-string">"this"</span>) <span class="cm-keyword">private</span> <span class="cm-variable">Point</span> <span class="cm-variable">location</span>, <span class="cm-variable">destination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Dispatcher</span> <span class="cm-variable">dispatcher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Taxi</span>(<span class="cm-variable">Dispatcher</span> <span class="cm-variable">dispatcher</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">dispatcher</span> <span class="cm-operator">=</span> <span class="cm-variable">dispatcher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable">Point</span> <span class="cm-variable">getLocation</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">location</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setLocation</span>(<span class="cm-variable">Point</span> <span class="cm-variable">location</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">boolean</span> <span class="cm-variable">reachedDestination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 加Taxi内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-keyword">this</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">location</span> <span class="cm-operator">=</span> <span class="cm-variable">location</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">reachedDestination</span> <span class="cm-operator">=</span> <span class="cm-variable">location</span>.<span class="cm-variable">equals</span>(<span class="cm-variable">destination</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 执行同步代码块后完毕，释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">reachedDestination</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 加Dispatcher内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">dispatcher</span>.<span class="cm-variable">notifyAvailable</span>(<span class="cm-keyword">this</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable">Point</span> <span class="cm-variable">getDestination</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">destination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">setDestination</span>(<span class="cm-variable">Point</span> <span class="cm-variable">destination</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">destination</span> <span class="cm-operator">=</span> <span class="cm-variable">destination</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@ThreadSafe</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Dispatcher</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@GuardedBy</span>(<span class="cm-string">"this"</span>) <span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span> <span class="cm-variable">taxis</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@GuardedBy</span>(<span class="cm-string">"this"</span>) <span class="cm-keyword">private</span> <span class="cm-keyword">final</span> <span class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span> <span class="cm-variable">availableTaxis</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Dispatcher</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">taxis</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">availableTaxis</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-variable">notifyAvailable</span>(<span class="cm-variable">Taxi</span> <span class="cm-variable">taxi</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">availableTaxis</span>.<span class="cm-variable">add</span>(<span class="cm-variable">taxi</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">Image</span> <span class="cm-variable">getImage</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Set</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span> <span class="cm-variable">copy</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// Dispatcher内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-keyword">this</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">copy</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">HashSet</span><span class="cm-operator">&lt;</span><span class="cm-variable">Taxi</span><span class="cm-operator">&gt;</span>(<span class="cm-variable">taxis</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 执行同步代码块后完毕，释放锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Image</span> <span class="cm-variable">image</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Image</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable">Taxi</span> <span class="cm-variable">t</span> : <span class="cm-variable">copy</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 加Taix内置锁</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">image</span>.<span class="cm-variable">drawMarker</span>(<span class="cm-variable">t</span>.<span class="cm-variable">getLocation</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">image</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">class</span> <span class="cm-def">Image</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">drawMarker</span>(<span class="cm-variable">Point</span> <span class="cm-variable">p</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 1716px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1716px;"></div></div></div></pre><p><span>使用开放调用是</span><strong><span>非常好的一种方式</span></strong><span>，应该尽量使用它~</span></p><h3><a name="23使用定时锁" class="md-header-anchor"></a><span>2.3使用定时锁</span></h3><p><span>使用显式Lock锁，在获取锁时使用</span><code>tryLock()</code><span>方法。当等待</span><strong><span>超过时限</span></strong><span>的时候，</span><code>tryLock()</code><span>不会一直等待，而是返回错误信息。</span></p><p><span>使用</span><code>tryLock()</code><span>能够有效避免死锁问题~~</span></p><h3><a name="24死锁检测" class="md-header-anchor"></a><span>2.4死锁检测</span></h3><p><span>虽然造成死锁的原因是因为我们设计得不够好，但是可能写代码的时候不知道哪里发生了死锁。</span></p><p><span>JDK提供了两种方式来给我们检测：</span></p><ul><li><span>JconsoleJDK自带的图形化界面工具，使用JDK给我们的的工具JConsole</span></li><li><span>Jstack是JDK自带的命令行工具，主要用于线程Dump分析。</span></li></ul><p><span>具体可参考：</span></p><ul><li><a href='https://www.cnblogs.com/flyingeagle/articles/6853167.html'><span>https://www.cnblogs.com/flyingeagle/articles/6853167.html</span></a></li></ul><h2><a name="三死锁总结" class="md-header-anchor"></a><span>三、死锁总结</span></h2><p><span>发生死锁的原因主要由于：</span></p><ul><li><p><span>线程之间交错执行</span></p><ul><li><span>解决：</span><strong><span>以固定的顺序加锁</span></strong></li></ul></li><li><p><span>执行某方法时就需要持有锁，且不释放</span></p><ul><li><span>解决：</span><strong><span>缩减同步代码块范围，最好仅操作共享变量时才加锁</span></strong></li></ul></li><li><p><span>永久等待</span></p><ul><li><span>解决：使用</span><code>tryLock()</code><span>定时锁，超过时限则返回错误信息</span></li></ul></li></ul><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnythvd93j307806qglo.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><p>&nbsp;</p><h1><a name="九线程常用的工具类" class="md-header-anchor"></a><span>九、线程常用的工具类</span></h1><p>&nbsp;</p><p><span>Java为我们提供了</span><strong><span>三个同步工具类</span></strong><span>：</span></p><ul><li><span>CountDownLatch(闭锁)</span></li><li><span>CyclicBarrier(栅栏)</span></li><li><span>Semaphore(信号量)</span></li></ul><p><span>这几个工具类其实说白了就是为了能够</span><strong><span>更好控制线程之间的通讯问题</span></strong><span>~</span></p><h2><a name="一countdownlatch" class="md-header-anchor"></a><span>一、CountDownLatch</span></h2><h3><a name="11countdownlatch简介" class="md-header-anchor"></a><span>1.1CountDownLatch简介</span></h3><blockquote><ul><li><span>A synchronization aid that allows one or more threads to wait until a set of operations being performed in other threads completes.</span></li></ul></blockquote><p><span>简单来说：CountDownLatch是一个同步的辅助类，</span><strong><span>允许一个或多个线程一直等待</span></strong><span>，</span><strong><span>直到</span></strong><span>其它线程</span><strong><span>完成</span></strong><span>它们的操作。</span></p><p><span>它常用的API其实就两个:</span><code>await()</code><span>和</span><code>countDown()</code></p><p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164d942fd946ec7d?w=468&amp;h=298&amp;f=png&amp;s=14667" referrerpolicy="no-referrer"></p><p><span>使用说明：</span></p><ul><li><span>count初始化CountDownLatch，然后需要等待的线程调用await方法。await方法会一直受阻塞直到count=0。而其它线程完成自己的操作后，调用</span><code>countDown()</code><span>使计数器count减1。</span><strong><span>当count减到0时，所有在等待的线程均会被释放</span></strong></li><li><span>说白了就是通过</span><strong><span>count变量来控制等待</span></strong><span>，如果</span><strong><span>count值为0了</span></strong><span>(其他线程的任务都完成了)，那就可以继续执行。</span></li></ul><h3><a name="12countdownlatch例子" class="md-header-anchor"></a><span>1.2CountDownLatch例子</span></h3><p><span>例子：3y现在去做实习生了，其他的员工还没下班，3y不好意思先走，等其他的员工都走光了，3y再走。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">CountDownLatch</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Test</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">CountDownLatch</span> <span class="cm-variable">countDownLatch</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">CountDownLatch</span>(<span class="cm-number">5</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"现在6点下班了....."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 3y线程启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 这里调用的是await()不是wait()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">countDownLatch</span>.<span class="cm-variable">await</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"...其他的5个员工走光了，3y终于可以走了"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 其他员工线程启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"员工xxxx下班了"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">countDownLatch</span>.<span class="cm-variable">countDown</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 836px;"></div><div class="CodeMirror-gutters" style="display: none; height: 836px;"></div></div></div></pre><p><span>输出结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164d942f79acba92?w=966&amp;h=309&amp;f=png&amp;s=14967" referrerpolicy="no-referrer"></p><p><span>再写个例子：3y现在负责仓库模块功能，但是能力太差了，写得很慢，</span><strong><span>别的员工都需要等3y写好了才能继续往下写。</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">CountDownLatch</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Test</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">CountDownLatch</span> <span class="cm-variable">countDownLatch</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">CountDownLatch</span>(<span class="cm-number">1</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 3y线程启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">5</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"3y终于写完了"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">countDownLatch</span>.<span class="cm-variable">countDown</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 其他员工线程启动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">5</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(<span class="cm-keyword">new</span> <span class="cm-variable">Runnable</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">run</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"其他员工需要等待3y"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">countDownLatch</span>.<span class="cm-variable">await</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"3y终于写完了，其他员工可以开始了！"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 902px;"></div><div class="CodeMirror-gutters" style="display: none; height: 902px;"></div></div></div></pre><p><span>输出结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164d942fde3ef945?w=1054&amp;h=502&amp;f=png&amp;s=37396" referrerpolicy="no-referrer"></p><p>&nbsp;</p><h2><a name="二cyclicbarrier" class="md-header-anchor"></a><span>二、CyclicBarrier</span></h2><h3><a name="21cyclicbarrier简介" class="md-header-anchor"></a><span>2.1CyclicBarrier简介</span></h3><blockquote><ul><li><span>A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier point.  CyclicBarriers are useful in programs involving a fixed sized party of threads that must occasionally wait for each other. The barrier is called </span><em><span>cyclic</span></em><span> because it can be re-used after the waiting threads are released.</span></li></ul></blockquote><p><span>简单来说：CyclicBarrier允许一组线程互相等待，直到</span><strong><span>到达某个公共屏障点</span></strong><span>。叫做cyclic是因为当所有等待线程都被释放以后，CyclicBarrier可以</span><strong><span>被重用</span></strong><span>(对比于CountDownLatch是不能重用的)</span></p><p><span>使用说明：</span></p><ul><li><span>CountDownLatch注重的是</span><strong><span>等待其他线程完成</span></strong><span>，CyclicBarrier注重的是：当线程</span><strong><span>到达某个状态</span></strong><span>后，暂停下来等待其他线程，</span><strong><span>所有线程均到达以后</span></strong><span>，继续执行。</span></li></ul><h3><a name="22cyclicbarrier例子" class="md-header-anchor"></a><span>2.2CyclicBarrier例子</span></h3><p><span>例子：3y和女朋友约了去广州夜上海吃东西，由于3y和3y女朋友住的地方不同，自然去的路径也就不一样了。于是他俩约定在体育西路地铁站</span><strong><span>集合</span></strong><span>，约定等到</span><strong><span>相互见面的时候</span></strong><span>就发一条朋友圈。</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">BrokenBarrierException</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">CyclicBarrier</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Test</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">CyclicBarrier</span> <span class="cm-variable">CyclicBarrier</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">CyclicBarrier</span>(<span class="cm-number">2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">2</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(() <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">getName</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">name</span>.<span class="cm-variable">equals</span>(<span class="cm-string">"Thread-0"</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"3y"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"女朋友"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-string">"到了体育西"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 两个人都要到体育西才能发朋友圈</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CyclicBarrier</span>.<span class="cm-variable">await</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 他俩到达了体育西，看见了对方发了一条朋友圈：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"跟"</span> <span class="cm-operator">+</span> <span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-string">"去夜上海吃东西~"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">BrokenBarrierException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 748px;"></div><div class="CodeMirror-gutters" style="display: none; height: 748px;"></div></div></div></pre><p><span>测试结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164d942fdd7161dc?w=915&amp;h=202&amp;f=png&amp;s=12542" referrerpolicy="no-referrer"></p><p><span>玩了一天以后，</span><strong><span>各自回到家里</span></strong><span>，3y和女朋友约定</span><strong><span>各自洗澡完之后再聊天</span></strong></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">BrokenBarrierException</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">CyclicBarrier</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Test</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">CyclicBarrier</span> <span class="cm-variable">CyclicBarrier</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">CyclicBarrier</span>(<span class="cm-number">2</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">2</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(() <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">String</span> <span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>().<span class="cm-variable">getName</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">name</span>.<span class="cm-variable">equals</span>(<span class="cm-string">"Thread-0"</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"3y"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">else</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">name</span> <span class="cm-operator">=</span> <span class="cm-string">"女朋友"</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-string">"到了体育西"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 两个人都要到体育西才能发朋友圈</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CyclicBarrier</span>.<span class="cm-variable">await</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 他俩到达了体育西，看见了对方发了一条朋友圈：</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"跟"</span> <span class="cm-operator">+</span> <span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-string">"去夜上海吃东西~"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 回家</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CyclicBarrier</span>.<span class="cm-variable">await</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">name</span> <span class="cm-operator">+</span> <span class="cm-string">"洗澡"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 洗澡完之后一起聊天</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">CyclicBarrier</span>.<span class="cm-variable">await</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"一起聊天"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">BrokenBarrierException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 968px;"></div><div class="CodeMirror-gutters" style="display: none; height: 968px;"></div></div></div></pre><p><span>测试结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164d942fd928d454?w=1010&amp;h=330&amp;f=png&amp;s=23058" referrerpolicy="no-referrer"></p><p>&nbsp;</p><h2><a name="三semaphore" class="md-header-anchor"></a><span>三、Semaphore</span></h2><h3><a name="31semaphore简介" class="md-header-anchor"></a><span>3.1Semaphore简介</span></h3><blockquote><p><span>Semaphores are often used to </span><strong><span>restrict the number of threads than can access some (physical or logical) resource</span></strong><span>.</span></p></blockquote><hr /><blockquote><ul><li><span>A counting semaphore.  Conceptually, a semaphore maintains a set of permits.  Each {@link #acquire} blocks if necessary until a permit is available, and then takes it.  Each {@link #release} adds a permit,potentially releasing a blocking acquirer.However, no actual permit objects are used; the {@code Semaphore} just</span>
<span>keeps a count of the number available and acts accordingly.</span></li></ul></blockquote><p><span>Semaphore(信号量)实际上就是可以控制</span><strong><span>同时访问的线程个数</span></strong><span>，它维护了一组</span><strong><span>&quot;许可证&quot;</span></strong><span>。</span></p><ul><li><span>当调用</span><code>acquire()</code><span>方法时，会消费一个许可证。如果没有许可证了，会阻塞起来</span></li><li><span>当调用</span><code>release()</code><span>方法时，会添加一个许可证。</span></li><li><span>这些&quot;许可证&quot;的个数其实就是一个count变量罢了~</span></li></ul><h3><a name="32semaphore例子" class="md-header-anchor"></a><span>3.2Semaphore例子</span></h3><p><span>3y女朋友开了一间卖酸奶的小店，小店一次只能容纳5个顾客挑选购买，超过5个就需要排队啦~~~</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">util</span>.<span class="cm-variable">concurrent</span>.<span class="cm-variable">Semaphore</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Test</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 假设有50个同时来到酸奶店门口</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">nums</span> <span class="cm-operator">=</span> <span class="cm-number">50</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 酸奶店只能容纳10个人同时挑选酸奶</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Semaphore</span> <span class="cm-variable">semaphore</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Semaphore</span>(<span class="cm-number">10</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-variable">nums</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">int</span> <span class="cm-variable">finalI</span> <span class="cm-operator">=</span> <span class="cm-variable">i</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">new</span> <span class="cm-variable">Thread</span>(() <span class="cm-operator">-&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 有"号"的才能进酸奶店挑选购买</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">semaphore</span>.<span class="cm-variable">acquire</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"顾客"</span> <span class="cm-operator">+</span> <span class="cm-variable">finalI</span> <span class="cm-operator">+</span> <span class="cm-string">"在挑选商品，购买..."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 假设挑选了xx长时间，购买了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span>.<span class="cm-variable">sleep</span>(<span class="cm-number">1000</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 归还一个许可，后边的就可以进来购买了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"顾客"</span> <span class="cm-operator">+</span> <span class="cm-variable">finalI</span> <span class="cm-operator">+</span> <span class="cm-string">"购买完毕了..."</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">semaphore</span>.<span class="cm-variable">release</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">InterruptedException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }).<span class="cm-variable">start</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 880px;"></div><div class="CodeMirror-gutters" style="display: none; height: 880px;"></div></div></div></pre><p><span>输出结果：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/7/27/164d942fdb70a172?w=1147&amp;h=620&amp;f=png&amp;s=48679" referrerpolicy="no-referrer"></p><p><span>反正每次只能</span><strong><span>5个客户同时</span></strong><span>进酸奶小店购买挑选。</span></p><p>&nbsp;</p><h2><a name="四总结" class="md-header-anchor"></a><span>四、总结</span></h2><p><span>Java为我们提供了</span><strong><span>三个同步工具类</span></strong><span>：</span></p><ul><li><p><span>CountDownLatch(闭锁)</span></p><ul><li><span>某个线程等待其他线程</span><strong><span>执行完毕后</span></strong><span>，它才执行(其他线程等待某个线程</span><strong><span>执行完毕后</span></strong><span>，它才执行)</span></li></ul></li><li><p><span>CyclicBarrier(栅栏)</span></p><ul><li><span>一组线程</span><strong><span>互相等待至某个状态</span></strong><span>，这组线程再同时执行。</span></li></ul></li><li><p><span>Semaphore(信号量)</span></p><ul><li><strong><span>控制一组线程同时执行</span></strong><span>。</span></li></ul></li></ul><p><span>本文简单的介绍了一下这三个同步工具类是干嘛用的，要</span><strong><span>深入还得看源码</span></strong><span>或者借鉴其他的资料。</span></p><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyxk0p5kj3073073glh.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><p>&nbsp;</p><h1><a name="十atomic" class="md-header-anchor"></a><span>十、Atomic</span></h1><p>&nbsp;</p><h2><a name="一基础铺垫" class="md-header-anchor"></a><span>一、基础铺垫</span></h2><p><span>首先我们来个例子：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">AtomicMain</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">InterruptedException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ExecutorService</span> <span class="cm-variable">service</span> <span class="cm-operator">=</span> <span class="cm-variable">Executors</span>.<span class="cm-variable">newCachedThreadPool</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Count</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Count</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 100个线程对共享变量进行加1</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">for</span> (<span class="cm-variable-3">int</span> <span class="cm-variable">i</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">i</span> <span class="cm-operator">&lt;</span> <span class="cm-number">100</span>; <span class="cm-variable">i</span><span class="cm-operator">++</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">service</span>.<span class="cm-variable">execute</span>(() <span class="cm-operator">-&gt;</span> <span class="cm-variable">count</span>.<span class="cm-variable">increase</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">// 等待上述的线程执行完</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">service</span>.<span class="cm-variable">shutdown</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">service</span>.<span class="cm-variable">awaitTermination</span>(<span class="cm-number">1</span>, <span class="cm-variable">TimeUnit</span>.<span class="cm-variable">DAYS</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"公众号：Java3y---------"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">count</span>.<span class="cm-variable">getCount</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Count</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 共享变量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">Integer</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">Integer</span> <span class="cm-variable">getCount</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">count</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> &nbsp;<span class="cm-variable-3">void</span> <span class="cm-variable">increase</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">count</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 748px;"></div><div class="CodeMirror-gutters" style="display: none; height: 748px;"></div></div></div></pre><p><span>你们猜猜得出的结果是多少？是100吗？</span></p><p><span>多运行几次可以发现：</span><strong><span>结果是不确定的</span></strong><span>，可能是95，也可能是98，也可能是100</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995fea017a5b" referrerpolicy="no-referrer" alt="结果不确定"></p><p><span>根据结果我们得知：上面的代码是</span><strong><span>线程不安全</span></strong><span>的！如果线程安全的代码，多次执行的结果是一致的！</span></p><p><span>我们可以发现问题所在：</span><code>count++</code><span>并</span><strong><span>不是原子</span></strong><span>操作。因为</span><code>count++</code><span>需要经过</span><code>读取-修改-写入</code><span>三个步骤。举个例子：</span></p><ul><li><span>如果某一个时刻：线程A读到count的值是10，线程B读到count的值也是10</span></li><li><span>线程A对</span><code>count++</code><span>，此时count的值为11</span></li><li><span>线程B对</span><code>count++</code><span>，此时count的值也是11(因为线程B读到的count是10)</span></li><li><span>所以到这里应该知道为啥我们的结果是不确定了吧。</span></li></ul><p><span>要将上面的代码变成线程安全的(每次得出的结果是100)，那也很简单，毕竟我们是学过synchronized锁的人：</span></p><ul><li><span>在</span><code>increase()</code><span>加synchronized锁就好了</span></li></ul><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">synchronized</span> <span class="cm-variable-3">void</span> <span class="cm-def">increase</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">count</span><span class="cm-operator">++</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p><span>无论执行多少次，得出的都是100：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995fe9d2a24c?w=884&amp;h=138&amp;f=png&amp;s=4407" referrerpolicy="no-referrer" alt="结果都是100"></p><p>&nbsp;</p><p><span>从上面的代码我们也可以发现，只做一个</span><code>++</code><span>这么简单的操作，都用到了synchronized锁，未免有点小题大做了。</span></p><ul><li><span>Synchronized锁是独占的，意味着如果有别的线程在执行，当前线程只能是等待！</span></li></ul><p><span>于是我们</span><strong><span>原子变量</span></strong><span>的类就登场了！</span></p><h3><a name="12cas再来看看" class="md-header-anchor"></a><span>1.2CAS再来看看</span></h3><p><span>在写文章之前，本以为对CAS有一定的了解了(因为之前已经看过相关概念，以为自己理解了)..但真正敲起键盘写的时候，还是发现没完全弄懂...所以再来看看CAS吧。</span></p><p><span>来源维基百科：</span></p><blockquote><p><span>比较并交换(compare and swap, CAS)，是</span><strong><span>原子</span></strong><span>操作的一种，可用于在多线程编程中实现</span><strong><span>不被打断的数据交换操作</span></strong><span>，从而避免多线程同时改写某一数据时由于执行顺序不确定性以及中断的不可预知性产生的数据不一致问题。 该操作通过将内存中的值与指定数据进行比较，当数值一样时将内存中的数据替换为新的值。</span></p></blockquote><p><span>CAS有3个操作数：</span></p><ul><li><span>内存值V</span></li><li><span>旧的预期值A</span></li><li><span>要修改的新值B</span></li></ul><p><span>当多个线程尝试使用CAS同时更新同一个变量时，</span><strong><span>只有其中一个线程能更新变量的值</span></strong><span>(A和内存值V相同时，将内存值V修改为B)，而其它线程都失败，失败的线程并不会被挂起，而是被告知这次竞争中失败，</span><strong><span>并可以再次尝试(或者什么都不做)</span></strong><span>。</span></p><p><span>我们画张图来理解一下：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995fec2109f9?w=686&amp;h=296&amp;f=png&amp;s=36466" referrerpolicy="no-referrer" alt="CAS理解"></p><p><span>我们可以发现CAS有两种情况：</span></p><ul><li><p><span>如果内存值V和我们的预期值A</span><strong><span>相等</span></strong><span>，则将内存值修改为B，操作成功！</span></p></li><li><p><span>如果内存值V和我们的预期值A</span><strong><span>不相等</span></strong><span>，一般也有两种情况：</span></p><ul><li><span>重试(自旋)</span></li><li><span>什么都不做</span></li></ul></li></ul><p><span>我们再继续往下看，如果内存值V和我们的预期值A</span><strong><span>不相等</span></strong><span>时，应该什么时候重试，什么时候什么都不做。</span></p><h4><a name="121cas失败重试自旋" class="md-header-anchor"></a><span>1.2.1CAS失败重试(自旋)</span></h4><p><span>比如说，我上面用了100个线程，对count值进行加1。我们都知道：如果在线程安全的情况下，这个count值最终的结果一定是为100的。那就意味着：</span><strong><span>每个线程都会对这个count值实质地进行加1</span></strong><span>。</span></p><p><span>我继续画张图来说明一下CAS是如何重试(循环再试)的：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995ff0117a59?w=1046&amp;h=1697&amp;f=png&amp;s=191720" referrerpolicy="no-referrer" alt="CAS循环重试"></p><p><span>上面图只模拟出两个线程的情况，但足够说明问题了。</span></p><h4><a name="122cas失败什么都不做" class="md-header-anchor"></a><span>1.2.2CAS失败什么都不做</span></h4><p><span>上面是每个线程都要为count值加1，但我们也可以有这种情况：</span><strong><span>将count值设置为5</span></strong></p><p><span>我也来画个图说明一下：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995fecc0fc19?w=1156&amp;h=1075&amp;f=png&amp;s=152144" referrerpolicy="no-referrer" alt="CAS失败什么都不做"></p><p><span>理解CAS的核心就是：</span><strong><span>CAS是原子性的</span></strong><span>，虽然你可能看到比较后再修改(compare and swap)觉得会有两个操作，但终究是原子性的！</span></p><h2><a name="二原子变量类简单介绍" class="md-header-anchor"></a><span>二、原子变量类简单介绍</span></h2><p><span>原子变量类在</span><code>java.util.concurrent.atomic</code><span>包下，总体来看有这么多个：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995e024d3c40?w=573&amp;h=478&amp;f=png&amp;s=9613" referrerpolicy="no-referrer" alt="原子变量类"></p><p><span>我们可以对其进行分类：</span></p><ul><li><p><span>基本类型：</span></p><ul><li><span>AtomicBoolean：布尔型</span></li><li><span>AtomicInteger：整型</span></li><li><span>AtomicLong：长整型</span></li></ul></li><li><p><span>数组：</span></p><ul><li><span>AtomicIntegerArray：数组里的整型</span></li><li><span>AtomicLongArray：数组里的长整型</span></li><li><span>AtomicReferenceArray：数组里的引用类型</span></li></ul></li><li><p><span>引用类型：</span></p><ul><li><span>AtomicReference：引用类型</span></li><li><span>AtomicStampedReference：带有版本号的引用类型</span></li><li><span>AtomicMarkableReference：带有标记位的引用类型</span></li></ul></li><li><p><span>对象的属性：</span></p><ul><li><span>AtomicIntegerFieldUpdater：对象的属性是整型</span></li><li><span>AtomicLongFieldUpdater：对象的属性是长整型</span></li><li><span>AtomicReferenceFieldUpdater：对象的属性是引用类型</span></li></ul></li><li><p><span>JDK8新增DoubleAccumulator、LongAccumulator、DoubleAdder、LongAdder</span></p><ul><li><span>是对AtomicLong等类的改进。比如LongAccumulator与LongAdder在高并发环境下比AtomicLong更高效。</span></li></ul></li></ul><p><span>Atomic包里的类基本都是使用</span><strong><span>Unsafe</span></strong><span>实现的包装类。</span></p><p><span>Unsafe里边有几个我们喜欢的方法(CAS)：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// 第一和第二个参数代表对象的实例以及地址，第三个参数代表期望值，第四个参数代表更新值</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-keyword">native</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">compareAndSwapObject</span>(<span class="cm-variable-3">Object</span> <span class="cm-variable">var1</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">var2</span>, <span class="cm-variable-3">Object</span> <span class="cm-variable">var4</span>, <span class="cm-variable-3">Object</span> <span class="cm-variable">var5</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-keyword">native</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">compareAndSwapInt</span>(<span class="cm-variable-3">Object</span> <span class="cm-variable">var1</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">var2</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">var4</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">var5</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">final</span> <span class="cm-keyword">native</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">compareAndSwapLong</span>(<span class="cm-variable-3">Object</span> <span class="cm-variable">var1</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">var2</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">var4</span>, <span class="cm-variable-3">long</span> <span class="cm-variable">var6</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 198px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p><span>从原理上概述就是：Atomic包的类的实现绝大调用Unsafe的方法，而Unsafe底层实际上是调用C代码，C代码调用汇编，最后生成出</span><strong><span>一条</span></strong><span>CPU指令cmpxchg，完成操作。这也就为啥CAS是原子性的，因为它是一条CPU指令，不会被打断。</span></p><h3><a name="21原子变量类使用" class="md-header-anchor"></a><span>2.1原子变量类使用</span></h3><p><span>既然我们上面也说到了，使用Synchronized锁有点小题大作了，我们用原子变量类来改一下：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">Count</span>{</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 共享变量(使用AtomicInteger来替代Synchronized锁)</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">AtomicInteger</span> <span class="cm-variable">count</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">AtomicInteger</span>(<span class="cm-number">0</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">Integer</span> <span class="cm-variable">getCount</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">count</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-variable">increase</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">count</span>.<span class="cm-variable">incrementAndGet</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">// Main方法还是如上</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 352px;"></div><div class="CodeMirror-gutters" style="display: none; height: 352px;"></div></div></div></pre><p><span>修改完，无论执行多少次，我们的结果永远是100！</span></p><p><span>其实Atomic包下原子类的使用方式都不会差太多，了解原子类各种类型，看看API，基本就会用了(网上也写得比较详细，所以我这里果断偷懒了)...</span></p><h3><a name="22aba问题" class="md-header-anchor"></a><span>2.2ABA问题</span></h3><p><span>使用CAS有个缺点就是ABA的问题，什么是ABA问题呢？首先我用文字描述一下：</span></p><ul><li><span>现在我有一个变量</span><code>count=10</code><span>，现在有三个线程，分别为A、B、C</span></li><li><span>线程A和线程C同时读到count变量，所以线程A和线程C的内存值和预期值都为10</span></li><li><span>此时线程A使用CAS将count值修改成100</span></li><li><span>修改完后，就在这时，线程B进来了，读取得到count的值为100(内存值和预期值都是100)，将count值修改成10</span></li><li><span>线程C拿到执行权，发现内存值是10，预期值也是10，将count值修改成11</span></li></ul><p><span>上面的操作都可以正常执行完的，这样会发生什么问题呢？？线程C无法得知线程A和线程B修改过的count值，这样是有</span><strong><span>风险</span></strong><span>的。</span></p><p><span>下面我再画个图来说明一下ABA的问题(以链表为例)：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/11/22/1673995e101cdd0d?w=1276&amp;h=1452&amp;f=png&amp;s=207716" referrerpolicy="no-referrer" alt="CAS ABA的问题讲解"></p><h3><a name="23解决aba问题" class="md-header-anchor"></a><span>2.3解决ABA问题</span></h3><p><span>要解决ABA的问题，我们可以使用JDK给我们提供的AtomicStampedReference和AtomicMarkableReference类。</span></p><p><span>AtomicStampedReference： </span></p><blockquote><p><span>An {@code AtomicStampedReference} maintains an object referencealong with an integer &quot;stamp&quot;, that can be updated atomically.</span></p></blockquote><p><span>简单来说就是在给为这个对象提供了一个</span><strong><span>版本</span></strong><span>，并且这个版本如果被修改了，是自动更新的。</span></p><p><span>原理大概就是：维护了一个Pair对象，Pair对象存储我们的对象引用和一个stamp值。每次CAS比较的是两个Pair对象</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// Pair对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">Pair</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable">T</span> <span class="cm-variable">reference</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">final</span> <span class="cm-variable-3">int</span> <span class="cm-variable">stamp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">Pair</span>(<span class="cm-variable">T</span> <span class="cm-variable">reference</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">stamp</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">reference</span> <span class="cm-operator">=</span> <span class="cm-variable">reference</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">stamp</span> <span class="cm-operator">=</span> <span class="cm-variable">stamp</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">Pair</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span> <span class="cm-variable">of</span>(<span class="cm-variable">T</span> <span class="cm-variable">reference</span>, <span class="cm-variable-3">int</span> <span class="cm-variable">stamp</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Pair</span><span class="cm-operator">&lt;</span><span class="cm-variable">T</span><span class="cm-operator">&gt;</span>(<span class="cm-variable">reference</span>, <span class="cm-variable">stamp</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">volatile</span> <span class="cm-variable">Pair</span><span class="cm-operator">&lt;</span><span class="cm-variable">V</span><span class="cm-operator">&gt;</span> <span class="cm-variable">pair</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 比较的是Pari对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">boolean</span> <span class="cm-def">compareAndSet</span>(<span class="cm-variable">V</span> &nbsp; <span class="cm-variable">expectedReference</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">V</span> &nbsp; <span class="cm-variable">newReference</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable-3">int</span> <span class="cm-variable">expectedStamp</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable-3">int</span> <span class="cm-variable">newStamp</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Pair</span><span class="cm-operator">&lt;</span><span class="cm-variable">V</span><span class="cm-operator">&gt;</span> <span class="cm-variable">current</span> <span class="cm-operator">=</span> <span class="cm-variable">pair</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expectedReference</span> <span class="cm-operator">==</span> <span class="cm-variable">current</span>.<span class="cm-variable">reference</span> <span class="cm-operator">&amp;&amp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">expectedStamp</span> <span class="cm-operator">==</span> <span class="cm-variable">current</span>.<span class="cm-variable">stamp</span> <span class="cm-operator">&amp;&amp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  ((<span class="cm-variable">newReference</span> <span class="cm-operator">==</span> <span class="cm-variable">current</span>.<span class="cm-variable">reference</span> <span class="cm-operator">&amp;&amp;</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">newStamp</span> <span class="cm-operator">==</span> <span class="cm-variable">current</span>.<span class="cm-variable">stamp</span>) <span class="cm-operator">||</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">casPair</span>(<span class="cm-variable">current</span>, <span class="cm-variable">Pair</span>.<span class="cm-variable">of</span>(<span class="cm-variable">newReference</span>, <span class="cm-variable">newStamp</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 660px;"></div><div class="CodeMirror-gutters" style="display: none; height: 660px;"></div></div></div></pre><p><span>因为多了一个版本号比较，所以就不会存在ABA的问题了。</span></p><h3><a name="24longadder性能比atomiclong要好" class="md-header-anchor"></a><span>2.4LongAdder性能比AtomicLong要好</span></h3><blockquote><p><span>如果是 JDK8，推荐使用 LongAdder 对象，比 AtomicLong 性能更好(减少乐观锁的重试次数)。</span></p></blockquote><p><span>去查阅了一些博客和资料，大概的意思就是：</span></p><ul><li><p><span>使用AtomicLong时，在高并发下大量线程会同时去竞争更新</span><strong><span>同一个原子变量</span></strong><span>，但是由于同时只有一个线程的CAS会成功，所以其他线程会不断尝试自旋尝试CAS操作，这会浪费不少的CPU资源。</span></p></li><li><p><span>而LongAdder可以概括成这样：内部核心数据value</span><strong><span>分离</span></strong><span>成一个数组(Cell)，每个线程访问时,通过哈希等算法映射到其中一个数字进行计数，而最终的计数结果，则为这个数组的</span><strong><span>求和累加</span></strong><span>。</span></p><ul><li><span>简单来说就是将一个值分散成多个值，在并发的时候就可以</span><strong><span>分散压力</span></strong><span>，性能有所提高。</span></li></ul></li></ul><p><span>参考资料：</span></p><ul><li><span>AtomicLong与LongAdder性能对比</span><a href='https://zhuanlan.zhihu.com/p/45489739'><span>https://zhuanlan.zhihu.com/p/45489739</span></a></li><li><span>LongAdder源码详解</span><a href='https://zhuanlan.zhihu.com/p/38288416'><span>https://zhuanlan.zhihu.com/p/38288416</span></a></li></ul><p>&nbsp;</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyxk0p5kj3073073glh.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p><h1><a name="十一threadlocal" class="md-header-anchor"></a><span>十一、ThreadLocal</span></h1><p>&nbsp;</p><h2><a name="一什么是threadlocal" class="md-header-anchor"></a><span>一、什么是ThreadLocal</span></h2><blockquote><p><span>声明：本文使用的是JDK 1.8</span></p></blockquote><p><span>首先我们来看一下JDK的文档介绍：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* This class provides thread-local variables.  These variables differ from</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* their normal counterparts in that each thread that accesses one (via its</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* {@code get} or {@code set} method) has its own, independently initialized</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* copy of the variable.  {@code ThreadLocal} instances are typically private</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* static fields in classes that wish to associate state with a thread (e.g.,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* a user ID or Transaction ID).</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* &lt;p&gt;For example, the class below generates unique identifiers local to each</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* thread.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* A thread's id is assigned the first time it invokes {@code ThreadId.get()}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-comment">* and remains unchanged on subsequent calls.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"> <span class="cm-comment">*/</span>  <span class="cm-tab" role="presentation" cm-text="	"> </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 308px;"></div><div class="CodeMirror-gutters" style="display: none; height: 308px;"></div></div></div></pre><p><span>结合我的总结可以这样理解：ThreadLocal提供了线程的局部变量，每个线程都可以通过</span><code>set()</code><span>和</span><code>get()</code><span>来对这个局部变量进行操作，但不会和其他线程的局部变量进行冲突，</span><strong><span>实现了线程的数据隔离</span></strong><span>～。</span></p><p><span>简要言之：往ThreadLocal中填充的变量属于</span><strong><span>当前</span></strong><span>线程，该变量对其他线程而言是隔离的。</span></p><h2><a name="二为什么要学习threadlocal" class="md-header-anchor"></a><span>二、为什么要学习ThreadLocal？</span></h2><p><span>从上面可以得出：ThreadLocal可以让我们拥有当前线程的变量，那这个作用有什么用呢？？？</span></p><h3><a name="21管理connection" class="md-header-anchor"></a><span>2.1管理Connection</span></h3><p><strong><span>最典型的是管理数据库的Connection：</span></strong><span>当时在学JDBC的时候，为了方便操作写了一个简单数据库连接池，需要数据库连接池的理由也很简单，频繁创建和关闭Connection是一件非常耗费资源的操作，因此需要创建数据库连接池～</span></p><p><span>那么，数据库连接池的连接怎么管理呢？？我们交由ThreadLocal来进行管理。为什么交给它来管理呢？？ThreadLocal能够实现</span><strong><span>当前线程的操作都是用同一个Connection，保证了事务！</span></strong></p><p><span>当时候写的代码：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">DBUtil</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//数据库连接池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable">BasicDataSource</span> <span class="cm-variable">source</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//为不同的线程管理连接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable">ThreadLocal</span><span class="cm-operator">&lt;</span><span class="cm-variable">Connection</span><span class="cm-operator">&gt;</span> <span class="cm-variable">local</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">static</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//加载配置文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Properties</span> <span class="cm-variable">properties</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Properties</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取读取流</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">InputStream</span> <span class="cm-variable">stream</span> <span class="cm-operator">=</span> <span class="cm-variable">DBUtil</span>.<span class="cm-keyword">class</span>.<span class="cm-variable">getClassLoader</span>().<span class="cm-variable">getResourceAsStream</span>(<span class="cm-string">"连接池/config.properties"</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//从配置文件中读取数据</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">properties</span>.<span class="cm-variable">load</span>(<span class="cm-variable">stream</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//关闭流</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">stream</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//初始化连接池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">BasicDataSource</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置驱动</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setDriverClassName</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"driver"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置url</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setUrl</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"url"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置用户名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setUsername</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"user"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置密码</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setPassword</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"pwd"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置初始连接数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setInitialSize</span>(<span class="cm-variable-3">Integer</span>.<span class="cm-variable">parseInt</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"initsize"</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置最大的连接数量</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setMaxActive</span>(<span class="cm-variable-3">Integer</span>.<span class="cm-variable">parseInt</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"maxactive"</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置最长的等待时间</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setMaxWait</span>(<span class="cm-variable-3">Integer</span>.<span class="cm-variable">parseInt</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"maxwait"</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//设置最小空闲数</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">source</span>.<span class="cm-variable">setMinIdle</span>(<span class="cm-variable-3">Integer</span>.<span class="cm-variable">parseInt</span>(<span class="cm-variable">properties</span>.<span class="cm-variable">getProperty</span>(<span class="cm-string">"minidle"</span>)));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//初始化线程本地</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">local</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ThreadLocal</span><span class="cm-operator">&lt;&gt;</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">IOException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">Connection</span> <span class="cm-variable">getConnection</span>() <span class="cm-keyword">throws</span> <span class="cm-variable">SQLException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">local</span>.<span class="cm-variable">get</span>()<span class="cm-operator">!=</span><span class="cm-atom">null</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">local</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }<span class="cm-keyword">else</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//获取Connection对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Connection</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">source</span>.<span class="cm-variable">getConnection</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//把Connection放进ThreadLocal里面</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">local</span>.<span class="cm-variable">set</span>(<span class="cm-variable">connection</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//返回Connection对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">connection</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//关闭数据库连接</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">closeConnection</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//从线程中拿到Connection对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Connection</span> <span class="cm-variable">connection</span> <span class="cm-operator">=</span> <span class="cm-variable">local</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">connection</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//恢复连接为自动提交</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">connection</span>.<span class="cm-variable">setAutoCommit</span>(<span class="cm-atom">true</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//这里不是真的把连接关了,只是将该连接归还给连接池</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">connection</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//既然连接已经归还给连接池了,ThreadLocal保存的Connction对象也已经没用了</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">local</span>.<span class="cm-variable">remove</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">SQLException</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 2222px;"></div><div class="CodeMirror-gutters" style="display: none; height: 2222px;"></div></div></div></pre><p><span>同样的，Hibernate对Connection的管理也是采用了相同的手法(使用ThreadLocal，当然了Hibernate的实现是更强大的)～</span></p><h3><a name="22避免一些参数传递" class="md-header-anchor"></a><span>2.2避免一些参数传递</span></h3><p><strong><span>避免一些参数的传递的理解</span></strong><span>可以参考一下Cookie和Session：</span></p><ul><li><span>每当我访问一个页面的时候，浏览器都会帮我们从硬盘中找到对应的Cookie发送过去。</span></li><li><span>浏览器是十分聪明的，不会发送别的网站的Cookie过去，只带当前网站发布过来的Cookie过去</span></li></ul><p><span>浏览器就相当于我们的ThreadLocal，它仅仅会发送我们当前浏览器存在的Cookie(ThreadLocal的局部变量)，不同的浏览器对Cookie是隔离的(Chrome,Opera,IE的Cookie是隔离的【在Chrome登陆了，在IE你也得重新登陆】)，同样地：线程之间ThreadLocal变量也是隔离的....</span></p><p><span>那上面避免了参数的传递了吗？？其实是避免了。Cookie并不是我们手动传递过去的，并不需要写</span><code>&lt;input name= cookie/&gt;</code><span>来进行传递参数...</span></p><p><span>在编写程序中也是一样的：日常中我们要去办理业务可能会有很多地方用到身份证，各类证件，每次我们都要掏出来很麻烦</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 咨询时要用身份证，学生证，房产证等等....</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">consult</span>(<span class="cm-variable">IdCard</span> <span class="cm-variable">idCard</span>,<span class="cm-variable">StudentCard</span> <span class="cm-variable">studentCard</span>,<span class="cm-variable">HourseCard</span> <span class="cm-variable">hourseCard</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 办理时还要用身份证，学生证，房产证等等....</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">manage</span>(<span class="cm-variable">IdCard</span> <span class="cm-variable">idCard</span>,<span class="cm-variable">StudentCard</span> <span class="cm-variable">studentCard</span>,<span class="cm-variable">HourseCard</span> <span class="cm-variable">hourseCard</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//......</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 264px;"></div><div class="CodeMirror-gutters" style="display: none; height: 264px;"></div></div></div></pre><p><span>而如果用了ThreadLocal的话，ThreadLocal就相当于一个机构，ThreadLocal机构做了记录你有那么多张证件。用到的时候就不用自己掏了，问机构拿就可以了。</span></p><p><span>在咨询时的时候就告诉机构：来，把我的身份证、房产证、学生证通通给他。在办理时又告诉机构：来，把我的身份证、房产证、学生证通通给他。...</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 咨询时要用身份证，学生证，房产证等等....</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">consult</span>(){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">threadLocal</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">// 办理时还要用身份证，学生证，房产证等等....</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">takePlane</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">threadLocal</span>.<span class="cm-variable">get</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p>&nbsp;</p><p><span>这样是不是比自己掏方便多了。</span></p><p><span>当然了，ThreadLocal可能还会有其他更好的作用，如果知道的同学可在评论留言哦～～～</span></p><p>&nbsp;</p><h2><a name="三threadlocal实现的原理" class="md-header-anchor"></a><span>三、ThreadLocal实现的原理</span></h2><p><span>想要更好地去理解ThreadLocal，那就得翻翻它是怎么实现的了～～～</span></p><blockquote><p><span>声明：本文使用的是JDK 1.8</span></p></blockquote><p><span>首先，我们来看一下ThreadLocal的set()方法，因为我们一般使用都是new完对象，就往里边set对象了</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable-3">void</span> <span class="cm-def">set</span>(<span class="cm-variable">T</span> <span class="cm-variable">value</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 得到当前线程对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" class="cm-tab-wrap-hack" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 这里获取ThreadLocalMap</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ThreadLocalMap</span> <span class="cm-variable">map</span> <span class="cm-operator">=</span> <span class="cm-variable">getMap</span>(<span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">// 如果map存在，则将当前线程对象t作为key，要存储的对象作为value存到map里面去</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">map</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">map</span>.<span class="cm-variable">set</span>(<span class="cm-keyword">this</span>, <span class="cm-variable">value</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">else</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">createMap</span>(<span class="cm-variable">t</span>, <span class="cm-variable">value</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 330px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><p><span>上面有个ThreadLocalMap，我们去看看这是什么？</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">ThreadLocalMap</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* The entries in this hash map extend WeakReference, using</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* its main ref field as the key (which is always a</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* ThreadLocal object).  Note that null keys (i.e. entry.get()</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* == null) mean that the key is no longer referenced, so the</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* entry can be expunged from table.  Such entries are referred to</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* as "stale entries" in the code that follows.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">Entry</span> <span class="cm-keyword">extends</span> <span class="cm-variable">WeakReference</span><span class="cm-operator">&lt;</span><span class="cm-variable">ThreadLocal</span><span class="cm-operator">&lt;?&gt;&gt;</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/** The value associated with this ThreadLocal. */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">Object</span> <span class="cm-variable">value</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Entry</span>(<span class="cm-variable">ThreadLocal</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">k</span>, <span class="cm-variable-3">Object</span> <span class="cm-variable">v</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">super</span>(<span class="cm-variable">k</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">v</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-tab" role="presentation" cm-text="	">  </span><span class="cm-comment">//....很长</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 462px;"></div><div class="CodeMirror-gutters" style="display: none; height: 462px;"></div></div></div></pre><p><span>通过上面我们可以发现的是</span><strong><span>ThreadLocalMap是ThreadLocal的一个内部类。用Entry类来进行存储</span></strong></p><p><span>我们的</span><strong><span>值都是存储到这个Map上的，key是当前ThreadLocal对象</span></strong><span>！</span></p><p><span>如果该Map不存在，则初始化一个：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable-3">void</span> <span class="cm-def">createMap</span>(<span class="cm-variable">Thread</span> <span class="cm-variable">t</span>, <span class="cm-variable">T</span> <span class="cm-variable">firstValue</span>) {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span>.<span class="cm-variable">threadLocals</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">ThreadLocalMap</span>(<span class="cm-keyword">this</span>, <span class="cm-variable">firstValue</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p><span>如果该Map存在，则</span><strong><span>从Thread中获取</span></strong><span>！</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* Get the map associated with a ThreadLocal. Overridden in</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* InheritableThreadLocal.</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @param  t the current thread</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* @return the map</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ThreadLocalMap</span> <span class="cm-def">getMap</span>(<span class="cm-variable">Thread</span> <span class="cm-variable">t</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">t</span>.<span class="cm-variable">threadLocals</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 242px;"></div><div class="CodeMirror-gutters" style="display: none; height: 242px;"></div></div></div></pre><p><span>Thread维护了ThreadLocalMap变量</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/* ThreadLocal values pertaining to this thread. This map is maintained</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* by the ThreadLocal class. */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-variable">ThreadLocal</span>.<span class="cm-variable">ThreadLocalMap</span> <span class="cm-variable">threadLocals</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 66px;"></div><div class="CodeMirror-gutters" style="display: none; height: 66px;"></div></div></div></pre><p><span>从上面又可以看出，</span><strong><span>ThreadLocalMap是在ThreadLocal中使用内部类来编写的，但对象的引用是在Thread中</span></strong><span>！</span></p><p><span>于是我们可以总结出：</span><strong><span>Thread为每个线程维护了ThreadLocalMap这么一个Map，而ThreadLocalMap的key是LocalThread对象本身，value则是要存储的对象</span></strong></p><p><span>有了上面的基础，我们看get()方法就一点都不难理解了：</span></p><pre spellcheck="false" class="md-fences md-end-block ty-contain-cm modeLoaded" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">T</span> <span class="cm-def">get</span>() {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Thread</span> <span class="cm-variable">t</span> <span class="cm-operator">=</span> <span class="cm-variable">Thread</span>.<span class="cm-variable">currentThread</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ThreadLocalMap</span> <span class="cm-variable">map</span> <span class="cm-operator">=</span> <span class="cm-variable">getMap</span>(<span class="cm-variable">t</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">map</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">ThreadLocalMap</span>.<span class="cm-variable">Entry</span> <span class="cm-variable">e</span> <span class="cm-operator">=</span> <span class="cm-variable">map</span>.<span class="cm-variable">getEntry</span>(<span class="cm-keyword">this</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">e</span> <span class="cm-operator">!=</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-meta">@SuppressWarnings</span>(<span class="cm-string">"unchecked"</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">T</span> <span class="cm-variable">result</span> <span class="cm-operator">=</span> (<span class="cm-variable">T</span>)<span class="cm-variable">e</span>.<span class="cm-variable">value</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">result</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">setInitialValue</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom-width: 0px; border-bottom-style: solid; border-bottom-color: transparent; top: 286px;"></div><div class="CodeMirror-gutters" style="display: none; height: 286px;"></div></div></div></pre><h3><a name="31threadlocal原理总结" class="md-header-anchor"></a><span>3.1ThreadLocal原理总结</span></h3><ol><li><span>每个Thread维护着一个ThreadLocalMap的引用</span></li><li><span>ThreadLocalMap是ThreadLocal的内部类，用Entry来进行存储</span></li><li><span>调用ThreadLocal的set()方法时，实际上就是往ThreadLocalMap设置值，key是ThreadLocal对象，值是传递进来的对象</span></li><li><span>调用ThreadLocal的get()方法时，实际上就是往ThreadLocalMap获取值，key是ThreadLocal对象</span></li><li><strong><span>ThreadLocal本身并不存储值</span></strong><span>，它只是</span><strong><span>作为一个key来让线程从ThreadLocalMap获取value</span></strong><span>。</span></li></ol><p><span>正因为这个原理，所以ThreadLocal能够实现“数据隔离”，获取当前线程的局部变量值，不受其他线程影响～</span></p><h2><a name="四避免内存泄露" class="md-header-anchor"></a><span>四、避免内存泄露</span></h2><p><span>我们来看一下ThreadLocal的对象关系引用图：</span></p><p><img src="https://user-gold-cdn.xitu.io/2018/4/3/162896ab1a1d1e2e?w=720&amp;h=452&amp;f=jpeg&amp;s=31576" referrerpolicy="no-referrer"></p><p><span>ThreadLocal内存泄漏的根源是：</span><strong><span>由于ThreadLocalMap的生命周期跟Thread一样长，如果没有手动删除对应key就会导致内存泄漏，而不是因为弱引用</span></strong><span>。</span></p><p><span>想要避免内存泄露就要</span><strong><span>手动remove()掉</span></strong><span>！</span></p><h2><a name="五总结" class="md-header-anchor"></a><span>五、总结</span></h2><p><span>ThreadLocal这方面的博文真的是数不胜数，随便一搜就很多很多～站在前人的肩膀上总结了这篇博文～</span></p><p><span>最后要记住的是:</span><strong><span>ThreadLocal设计的目的就是为了能够在当前线程中有属于自己的变量，并不是为了解决并发或者共享变量的问题</span></strong></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyvxnfymj30730733yf.jpg" referrerpolicy="no-referrer"></p><p><img src="https://tva1.sinaimg.cn/large/00831rSTly1gcnyqyo2bnj3076076dga.jpg" referrerpolicy="no-referrer"></p><p><span>如果⽂档中有任何的不懂的问题，都可以直接来找我询问，我乐意帮助你们！微信搜</span><strong><span>Java3y</span></strong><span>公众号有我的联系⽅式。更多</span><strong><span>原创</span></strong><span>技术⽂章可关注我的GitHub：</span><a href='https://github.com/ZhongFuCheng3y/3y' target='_blank' class='url'>https://github.com/ZhongFuCheng3y/3y</a></p></div>
</body>
</html>